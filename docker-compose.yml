version: "3.8"

services:
  ai:
    build:
      context: ./service/ai
      dockerfile: docker/Dockerfile
    container_name: gblob-ai
    command: ["python", "scripts/run_server.py", "--host", "0.0.0.0", "--port", "18000"]
    env_file:
      - ./service/ai/.env
    environment:
      ENVIRONMENT: production
      LOG_LEVEL: INFO
      LOG_DIR: /app/logs
      LOG_FILE: ai-service.log
      GALAY_DOCS_ROOT_PATH: ${GALAY_DOCS_CONTAINER_ROOT_PATH:-/docs/repos}
    volumes:
      - ./service/ai/data:/app/vector_store
      - ./service/ai/logs:/app/logs
      - ${GALAY_DOCS_ROOT_PATH:-/tmp/repos}:${GALAY_DOCS_CONTAINER_ROOT_PATH:-/docs/repos}:ro
    network_mode: host
    restart: unless-stopped

  backend:
    image: ubuntu-24.04:galay-web-1.0
    container_name: gblob-backend
    working_dir: /app
    command: ["./bin/backend-server", "-h", "0.0.0.0", "-p", "8080"]
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    network_mode: host
    volumes:
      - ./service/backend/bin:/app/bin:ro
      - ./service/backend/logs:/app/logs
    restart: unless-stopped

  static:
    image: ubuntu-24.04:galay-web-1.0
    container_name: gblob-static
    working_dir: /app
    command: ["./bin/static-server"]
    depends_on:
      - ai
      - backend
    environment:
      STATIC_HOST: 0.0.0.0
      STATIC_PORT: 80
      STATIC_FRONTEND_ROOT: /app/frontend
      STATIC_LOG_DIR: /app/logs
      STATIC_LOG_FILE: static-server.log
      STATIC_CONFIG_PATH: /app/config/static-server.conf
      API_PROXY_ENABLED: ${API_PROXY_ENABLED:-true}
      API_PROXY_ROUTES: ${API_PROXY_ROUTES:-/api,127.0.0.1,8080,http;/auth,127.0.0.1,8080,http;/ai,127.0.0.1,18000,http}
      LD_LIBRARY_PATH: /usr/local/lib
    network_mode: host
    volumes:
      - ./service/static/bin:/app/bin:ro
      - ./service/static/logs:/app/logs
      - ./service/static/config:/app/config:ro
      - ./frontend:/app/frontend:ro
    restart: unless-stopped
