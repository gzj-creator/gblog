version: "3.8"

services:
  ai:
    build:
      context: ./service/ai
      dockerfile: docker/Dockerfile
    container_name: gblob-ai
    env_file:
      - ./service/ai/.env
    environment:
      ENVIRONMENT: production
      LOG_LEVEL: INFO
      GALAY_DOCS_ROOT_PATH: ${GALAY_DOCS_CONTAINER_ROOT_PATH:-/docs/repos}
    volumes:
      - ./service/ai/vector_store:/app/vector_store
      - ${GALAY_DOCS_ROOT_PATH:-/tmp/repos}:${GALAY_DOCS_CONTAINER_ROOT_PATH:-/docs/repos}:ro
    restart: unless-stopped

  backend:
    image: ubuntu-24.04:galay-web-1.0
    container_name: gblob-backend
    working_dir: /app
    command: ["./bin/backend-server", "-h", "0.0.0.0", "-p", "8080"]
    environment:
      LD_LIBRARY_PATH: /usr/local/lib
    volumes:
      - ./service/backend/bin:/app/bin:ro
      - ./service/backend/logs:/app/logs
    restart: unless-stopped

  static:
    image: ubuntu-24.04:galay-web-1.0
    container_name: gblob-static
    working_dir: /app
    command: ["./bin/static-server"]
    depends_on:
      - ai
      - backend
    environment:
      STATIC_HOST: 0.0.0.0
      STATIC_PORT: 80
      STATIC_FRONTEND_ROOT: /app/frontend
      STATIC_LOG_DIR: /app/logs
      STATIC_LOG_FILE: static-server.log
      STATIC_CONFIG_PATH: /app/config/static-server.conf
      API_PROXY_ENABLED: ${API_PROXY_ENABLED:-true}
      API_PROXY_ROUTES: ${API_PROXY_ROUTES:-}
      API_PROXY_ROUTE_PREFIX: ${API_PROXY_ROUTE_PREFIX:-/api}
      API_PROXY_UPSTREAM_HOST: ${API_PROXY_UPSTREAM_HOST:-backend}
      API_PROXY_UPSTREAM_PORT: ${API_PROXY_UPSTREAM_PORT:-8080}
      API_PROXY_MODE: ${API_PROXY_MODE:-http}
      LD_LIBRARY_PATH: /usr/local/lib
    ports:
      - "80:80"
    volumes:
      - ./service/static/bin:/app/bin:ro
      - ./service/static/logs:/app/logs
      - ./service/static/config:/app/config:ro
      - ./frontend:/app/frontend:ro
    restart: unless-stopped
