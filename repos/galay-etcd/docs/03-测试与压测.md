# 测试与压测

## 1. 联通验证

```bash
nc -vz 140.143.142.251 2379
```

## 2. 功能测试

### 脚本 smoke（直接调 etcd API）

```bash
./scripts/manual_smoke.sh
```

覆盖：

- put / get / delete
- lease grant / keepalive
- lease 过期验证

### 库功能测试

```bash
./build/test/T1-EtcdSmoke http://140.143.142.251:2379
./build/test/T2-EtcdPrefixOps http://140.143.142.251:2379
./build/test/T3-EtcdPipeline http://140.143.142.251:2379
```

`T1` 覆盖单 key 与 lease 生命周期，`T2` 覆盖 prefix range/delete，`T3` 覆盖 pipeline(txn success ops)。

## 3. 压测

程序：`build/benchmark/B1-EtcdKvBenchmark`

参数：

1. `endpoint`：例如 `http://140.143.142.251:2379`
2. `threads`：并发线程数
3. `ops_per_thread`：每线程操作数
4. `value_size`：value 字节长度
5. `mode`：`put` 或 `mixed`（put+get）

示例：

```bash
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 500 64 put
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 300 128 mixed
```

输出指标：

- Success / Failure
- Duration
- Throughput（ops/s）
- Latency p50 / p95 / p99 / max（us）

## 4. 最近一次远端验收（2026-02-16）

目标：`http://140.143.142.251:2379`

功能测试：

```bash
./build/test/T1-EtcdSmoke http://140.143.142.251:2379
./build/test/T2-EtcdPrefixOps http://140.143.142.251:2379
./build/test/T3-EtcdPipeline http://140.143.142.251:2379
```

结果：

- `T1-EtcdSmoke`: `SMOKE TEST PASSED`
- `T2-EtcdPrefixOps`: `PREFIX TEST PASSED`
- `T3-EtcdPipeline`: `PIPELINE TEST PASSED`

压测：

```bash
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 200 64 put
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 100 64 mixed
```

结果：

- `put`（优化前样本）：Throughput `83.913 ops/s`，p50 `85033us`，p95 `117344us`，p99 `148134us`
- `put`（优化后样本）：Throughput `85.6146 ops/s`，p50 `84871us`，p95 `115872us`，p99 `165754us`
- `mixed(put+get)`（优化前样本）：Throughput `43.9453 ops/s`，p50 `167389us`，p95 `200679us`，p99 `215209us`
- `mixed(put+get)`（优化后样本）：Throughput `42.5042 ~ 41.8031 ops/s`，p50 `171799 ~ 172793us`，p95 `218517 ~ 214396us`，p99 `252236 ~ 229206us`

备注：

- 远端环境存在明显抖动，曾出现单次 `mixed` 样本 `p99 > 3s` 的长尾；建议至少跑 `3~5` 轮取中位数再做最终结论。

## 5. 单次解析优化后复测（2026-02-16）

改动：去掉 `PostJsonAwaitable` 的重复解析，业务等待体统一做一次 JSON+etcd 错误检查。

样本结果：

- `put`：`86.5694 ops/s`（另一轮 `104.439 ops/s`），`p95=203081us / 104295us`
- `mixed`：`41.4272 ops/s`（另一轮 `51.38 ops/s`），`p95=445782us / 185318us`

说明：

- 远端波动仍是主要噪声源；该优化主要收益在 CPU 与分配路径简化，吞吐提升需用多轮中位数观察。

## 6. 去除 promise/future 桥接后复测（2026-02-16）

改动：`EtcdClient` 改为协程会话包装，不再做 `promise/future` 阻塞桥接；测试与压测均改为协程 worker。

样本结果：

- `put`：Throughput `211.276 ops/s`，p50 `32930us`，p95 `38662us`，p99 `51270us`
- `mixed(put+get)`：Throughput `115.01 ops/s`，p50 `64369us`，p95 `72786us`，p99 `83081us`

说明：

- 相比旧的阻塞桥接模式，吞吐和尾延迟有明显改善。

## 7. 复用 HttpSession + put 快路径后复测（2026-02-16）

改动：

- `EtcdClient` 复用 `HttpSession`，避免每次请求创建 session/ring buffer
- `put` 成功路径仅在响应疑似包含错误字段时才解析 JSON

样本结果：

- `put`（8 workers）：Throughput `241.038 / 228.228 ops/s`，p50 `31214 / 32470us`，p95 `34158 ~ 35408us`
- `mixed`（8 workers）：Throughput `111.685 / 113.746 ops/s`，p50 `68246 / 63328us`，p95 `72775 / 70858us`
- `put`（32 workers）：Throughput `633.87 ops/s`，p50 `33430us`，p95 `41386us`

说明：

- 在 8 workers 下，`put` 仍有小幅提升；`mixed` 基本持平（远端波动影响较大）。
- 当前 8 workers 下已接近 RTT 上限，继续提 QPS 主要靠提高并发连接数或降低网络 RTT。

## 8. 去 HttpClient 传输层重构后复测（2026-02-16）

改动：

- `EtcdClient` 不再持有 `HttpClient`
- 连接层改为 `TcpSocket` 直连，连接/关闭等待体直接绑定 socket I/O
- 请求层使用 `HttpSessionAwaitable` 完整收发链路（请求发送 + 响应读满 + HTTP 解析完成后再唤醒）

功能回归：

```bash
./build/test/T1-EtcdSmoke http://140.143.142.251:2379
./build/test/T2-EtcdPrefixOps http://140.143.142.251:2379
```

结果：

- `T1-EtcdSmoke`: `SMOKE TEST PASSED`
- `T2-EtcdPrefixOps`: `PREFIX TEST PASSED`

压测：

```bash
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 200 64 put
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 8 100 64 mixed
./build/benchmark/B1-EtcdKvBenchmark http://140.143.142.251:2379 32 200 64 put
```

结果：

- `put`（8 workers）：Throughput `227.587 ~ 228.914 ops/s`，p50 `32346 ~ 32899us`，p95 `36111 ~ 35834us`
- `mixed`（8 workers）：Throughput `116.151 ops/s`，p50 `63555us`，p95 `68661us`
- `put`（32 workers）：Throughput `608.457 ops/s`，p50 `32596us`，p95 `39222us`

对比（参考上一阶段“复用 HttpSession + put 快路径”样本）：

- `put`（8 workers）：`228.228 ~ 241.038 ops/s` -> `227.587 ~ 228.914 ops/s`（基本持平，远端波动下小幅回落）
- `mixed`（8 workers）：`111.685 ~ 113.746 ops/s` -> `116.151 ops/s`（小幅提升）
- `put`（32 workers）：`633.87 ops/s` -> `608.457 ops/s`（远端抖动场景下可接受，建议多轮取中位数）
