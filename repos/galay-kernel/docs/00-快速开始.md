# 00-快速开始

## 依赖

- 支持 C++23 的编译器（推荐 GCC 11+、Clang 14+）
- CMake 3.16+
- spdlog（默认 `ENABLE_LOG=ON` 时需要）
- Linux 系统额外依赖：
  - `libaio`（epoll 文件 IO）
  - `liburing`（可选，启用 io_uring 时）

## 依赖安装

### macOS / Homebrew

```bash
brew install cmake spdlog
```

### Ubuntu / Debian

```bash
sudo apt-get update
sudo apt-get install -y cmake g++ libspdlog-dev libaio-dev liburing-dev
```

### Fedora / RHEL

```bash
sudo dnf install cmake gcc-c++ spdlog-devel libaio-devel liburing-devel
```

## 拉取与编译

```bash
git clone https://github.com/gzj-creator/galay-kernel.git
cd galay-kernel
mkdir -p build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --parallel
```

可执行文件默认输出到 `build/bin/`。

## CMake 构建选项

```cmake
option(BUILD_TESTS "Build test executables" ON)
option(BUILD_BENCHMARKS "Build benchmark executables" ON)
option(BUILD_EXAMPLES "Build example executables" ON)
option(ENABLE_LOG "Enable logging with spdlog" ON)
option(DISABLE_IOURING "Disable io_uring and use epoll on Linux" ON)
option(ENABLE_CPP23_MODULES "Enable experimental C++23 named modules support" OFF)
```

### 平台后端选择

- macOS: 自动使用 `kqueue`
- Linux + `DISABLE_IOURING=ON`（默认）: 使用 `epoll`
- Linux + `DISABLE_IOURING=OFF` 且系统有 `liburing`: 使用 `io_uring`

启用 io_uring：

```bash
cmake .. -DDISABLE_IOURING=OFF
```

### 禁用日志

```bash
cmake .. -DENABLE_LOG=OFF
```

## 运行测试

```bash
# 运行所有测试
cd build
ctest --output-on-failure

# 运行单个测试
./bin/T21-Runtime
./bin/T13-AsyncMutex
./bin/T1-TcpSocket
```

## 运行示例

```bash
# TCP Echo 服务器
./bin/E2-TcpEchoServer

# 在另一个终端测试
telnet 127.0.0.1 8080

# UDP Echo 示例
./bin/E5-UdpEcho

# 协程基础示例
./bin/E4-CoroutineBasic
```

## 运行基准测试

```bash
# TCP 服务器（监听 8080）
./bin/B2-TcpServer 8080

# 在另一个终端运行客户端压测
./bin/B3-TcpClient -h 127.0.0.1 -p 8080 -c 100 -s 256 -d 10
# -c: 并发连接数
# -s: 消息大小（字节）
# -d: 持续时间（秒）
```

## 最小 TCP Echo 服务示例

```cpp
#include "galay-kernel/kernel/Runtime.h"
#include "galay-kernel/async/TcpSocket.h"

using namespace galay::kernel;
using namespace galay::async;

Coroutine handleClient(GHandle handle, IOScheduler* scheduler) {
    TcpSocket client(handle);
    client.option().handleNonBlock();

    char buffer[4096];
    while (true) {
        auto recvResult = co_await client.recv(buffer, sizeof(buffer));
        if (!recvResult || recvResult.value().size() == 0) {
            break;
        }
        auto& bytes = recvResult.value();
        co_await client.send(bytes.c_str(), bytes.size());
    }

    co_await client.close();
}

Coroutine server(IOScheduler* scheduler) {
    TcpSocket listener(IPType::IPV4);
    listener.option().handleReuseAddr();
    listener.option().handleNonBlock();

    if (!listener.bind(Host(IPType::IPV4, "0.0.0.0", 8080))) {
        co_return;
    }
    if (!listener.listen(1024)) {
        co_return;
    }

    while (true) {
        Host peer;
        auto acceptResult = co_await listener.accept(&peer);
        if (acceptResult) {
            co_await spawn(handleClient(acceptResult.value(), scheduler));
        }
    }
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* io = runtime.getNextIOScheduler();
    io->spawn(server(io));

    std::this_thread::sleep_for(std::chrono::hours(24));
    runtime.stop();
    return 0;
}
```

## 最小协程休眠示例

```cpp
#include "galay-kernel/kernel/Runtime.h"
#include "galay-kernel/common/Sleep.hpp"
#include <iostream>

using namespace galay::kernel;
using namespace std::chrono_literals;

Coroutine task() {
    std::cout << "开始任务\n";
    co_await sleep(1s);
    std::cout << "1秒后\n";
    co_await sleep(2s);
    std::cout << "3秒后\n";
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* io = runtime.getNextIOScheduler();
    io->spawn(task());

    std::this_thread::sleep_for(5s);
    runtime.stop();
    return 0;
}
```

## C++23 模块（实验性）

项目提供模块门面 `galay.kernel`，支持 `import`/`export` 语法。

### 启用方式

```bash
cmake .. -DENABLE_CPP23_MODULES=ON -G Ninja
cmake --build . --parallel
```

### 模块能力生效条件

- CMake 版本 >= 3.28
- Generator 支持模块依赖扫描（推荐 Ninja / Visual Studio）
- 当前不支持 AppleClang 的模块构建路径
- 仅当以上条件满足时，`ENABLE_CPP23_MODULES=ON` 才会实际生效

### 模块示例

```cpp
import galay.kernel;

int main() {
    galay::kernel::Runtime runtime;
    runtime.start();

    auto* io = runtime.getNextIOScheduler();
    // ...

    runtime.stop();
    return 0;
}
```

### 构建模块示例

```bash
# include 版本（默认）
cmake --build . --target E1-SendfileExample E2-TcpEchoServer --parallel

# import 版本（需先启用模块）
cmake --build . --target E1-SendfileExampleImport E2-TcpEchoServerImport --parallel
```

可用的 import 示例目标：

- `E1-SendfileExampleImport`
- `E2-TcpEchoServerImport`
- `E3-TcpClientImport`
- `E4-CoroutineBasicImport`
- `E5-UdpEchoImport`
- `E6-MpscChannelImport`
- `E7-UnsafeChannelImport`
- `E8-AsyncSyncImport`
- `E9-TimerSleepImport`

## 常见问题

### 编译错误：找不到 spdlog

确保安装了 spdlog，或禁用日志：

```bash
cmake .. -DENABLE_LOG=OFF
```

### 链接错误：undefined reference

检查是否链接了必要的库：

```cmake
target_link_libraries(your_target PRIVATE galay-kernel spdlog::spdlog)
```

Linux 下可能还需要：

```cmake
target_link_libraries(your_target PRIVATE pthread aio)
```

### 运行时错误：Address already in use

端口被占用，更换端口或关闭占用进程：

```bash
# 查找占用进程
lsof -i :8080

# 杀死进程
kill -9 <PID>
```

### io_uring 编译失败

检查是否安装了 liburing：

```bash
# Ubuntu/Debian
sudo apt-get install liburing-dev

# 或禁用 io_uring
cmake .. -DDISABLE_IOURING=ON
```

## 下一步

- 查看 [架构设计](16-架构设计.md) 了解整体结构
- 查看 [API 文档](01-API文档.md) 了解完整接口
- 查看 [示例代码](17-示例代码.md) 学习常见用法
- 查看 [常见问题](18-常见问题.md) 解决疑难问题
- 查看 [高级主题](19-高级主题.md) 学习性能优化
