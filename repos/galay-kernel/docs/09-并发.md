# 09. 并发与通道

## MpscChannel（线程安全）

`MpscChannel<T>` 是多生产者单消费者通道，适合跨线程/跨调度器传递数据。

```cpp
template <typename T>
class MpscChannel {
public:
    bool send(T&& value);
    bool send(const T& value);

    bool sendBatch(const std::vector<T>& values);
    bool sendBatch(std::vector<T>&& values);

    MpscRecvAwaitable<T> recv();
    MpscRecvBatchAwaitable<T> recvBatch(size_t maxCount = DEFAULT_BATCH_SIZE);

    std::optional<T> tryRecv();
    std::optional<std::vector<T>> tryRecvBatch(size_t maxCount = DEFAULT_BATCH_SIZE);

    size_t size() const;
    bool empty() const;
};
```

### 示例

```cpp
MpscChannel<int> channel;

void producerThread() {
    for (int i = 0; i < 1000; ++i) {
        channel.send(i);
    }
}

Coroutine consumer() {
    while (true) {
        auto v = co_await channel.recv();
        if (!v) {
            co_return;
        }
        // use v.value()
    }
}
```

## UnsafeChannel（非线程安全，高性能）

`UnsafeChannel<T>` 只用于同一调度器线程内协程通信。

```cpp
template <typename T>
class UnsafeChannel {
public:
    bool send(T&& value, bool immediately = false);
    bool send(const T& value, bool immediately = false);

    bool sendBatch(const std::vector<T>& values, bool immediately = false);
    bool sendBatch(std::vector<T>&& values, bool immediately = false);

    UnsafeRecvAwaitable<T> recv();
    UnsafeRecvBatchAwaitable<T> recvBatch(size_t maxCount = DEFAULT_BATCH_SIZE);

    UnsafeRecvBatchedAwaitable<T> recvBatched(size_t limit);

    std::optional<T> tryRecv();
    std::optional<std::vector<T>> tryRecvBatch(size_t maxCount = DEFAULT_BATCH_SIZE);

    size_t size() const;
    bool empty() const;
};
```

### recvBatched 示例

```cpp
UnsafeChannel<int> channel;

Coroutine batchConsumer() {
    using namespace std::chrono_literals;

    while (true) {
        // 语义：攒到128条或50ms超时
        auto batch = co_await channel.recvBatched(128).timeout(50ms);
        if (!batch) {
            continue;
        }
        for (auto& v : batch.value()) {
            // process
        }
    }
}
```

## AsyncMutex / AsyncWaiter

并发同步原语已独立文档说明：

- [15-异步同步原语.md](15-异步同步原语.md)

## Bytes

`Bytes` 是轻量字节容器，适合网络收发结果承载：

```cpp
class Bytes {
public:
    Bytes();
    Bytes(size_t capacity);

    static Bytes fromString(std::string& str);
    static Bytes fromString(const std::string_view& str);
    static Bytes fromCString(const char* str, size_t length, size_t capacity);

    const uint8_t* data() const noexcept;
    const char* c_str() const noexcept;

    size_t size() const noexcept;
    size_t capacity() const noexcept;
    bool empty() const noexcept;

    void clear() noexcept;

    std::string toString() const;
    std::string_view toStringView() const;
};
```

## RingBuffer

高性能环形缓冲区单独文档：

- [11-环形缓冲区.md](11-环形缓冲区.md)

## UnsafeChannel 性能

通道专项性能数据可直接运行：`./build/bin/B9-UnsafeChannel`。
