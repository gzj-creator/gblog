# 14. 文件监控

## 概述

`FileWatcher` 提供协程友好的文件/目录变化监控：

- Linux: `inotify`（epoll/io_uring）
- macOS: `kqueue EVFILT_VNODE`

## API

```cpp
class FileWatcher {
public:
    FileWatcher();

    std::expected<int, IOError> addWatch(
        const std::string& path,
        FileWatchEvent events = FileWatchEvent::All);

    std::expected<void, IOError> removeWatch(int wd);

    FileWatchAwaitable watch(); // co_await -> std::expected<FileWatchResult, IOError>

    bool isValid() const;
    int fd() const;
    std::string getPath(int wd) const;
};
```

## 事件类型

```cpp
enum class FileWatchEvent : uint32_t {
    Access, Modify, Attrib,
    CloseWrite, CloseNoWrite,
    Open, MovedFrom, MovedTo,
    Create, Delete, DeleteSelf, MoveSelf,
    All
};
```

## 使用示例

```cpp
Coroutine watchConfig() {
    FileWatcher watcher;

    auto added = watcher.addWatch("/tmp/app.conf", FileWatchEvent::Modify | FileWatchEvent::Attrib);
    if (!added) {
        co_return;
    }

    while (true) {
        auto ev = co_await watcher.watch();
        if (!ev) {
            break;
        }

        if (ev->has(FileWatchEvent::Modify)) {
            // reload config
        }
    }
}
```

## 平台差异

1. Linux 监控目录时，`FileWatchResult::name` 会包含触发事件的文件名。
2. macOS `kqueue` 通常按文件维度监控，目录行为与 inotify 存在差异。
