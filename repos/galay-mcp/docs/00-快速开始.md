# 00-快速开始

本文档帮助你快速上手 Galay MCP 库，包括依赖安装、编译构建、运行测试和基本使用。

## 什么是 MCP？

MCP (Model Context Protocol) 是一个标准化协议，用于 AI 模型与外部工具、资源和提示之间的通信。Galay MCP 是基于 Galay-Kernel 框架实现的高性能 C++23 MCP 协议库。

## 核心特性

- **双传输支持**: Stdio（标准输入输出）和 HTTP 传输
- **完整协议实现**: 工具调用、资源管理、提示获取
- **类型安全**: 使用 `std::expected` 进行错误处理
- **高性能**: 基于 Galay-Kernel 的异步架构
- **C++23 模块**: 支持 `import galay.mcp;`
- **标准兼容**: 遵循 MCP 2024-11-05 规范

## 系统要求

### 编译器

- GCC 13+ 或 Clang 16+
- 支持 C++23 标准

### 依赖库

必需依赖：
- [galay-kernel](https://github.com/gzj-creator/galay-kernel) - 核心框架
- [galay-utils](https://github.com/gzj-creator/galay-utils) - 工具库
- [simdjson](https://github.com/simdjson/simdjson) - JSON 解析

HTTP 传输场景：
- [galay-http](https://github.com/gzj-creator/galay-http) - HTTP 支持

### 构建工具

- CMake 3.20+
- Ninja（推荐，用于 C++23 模块）

## 依赖安装

### macOS (Homebrew)

```bash
brew install cmake simdjson
```

### Ubuntu/Debian

```bash
sudo apt-get update
sudo apt-get install -y cmake g++ libsimdjson-dev
```

### Galay 依赖

推荐统一拉取所有 Galay 组件进行联调：

```bash
# 创建工作目录
mkdir galay-workspace && cd galay-workspace

# 克隆依赖
git clone https://github.com/gzj-creator/galay-kernel.git
git clone https://github.com/gzj-creator/galay-utils.git
git clone https://github.com/gzj-creator/galay-http.git
git clone https://github.com/gzj-creator/galay-mcp.git
```

## 编译构建

### 基本构建

```bash
cd galay-mcp
mkdir build && cd build
cmake ..
cmake --build . --parallel
```

### 构建选项

```bash
# 不构建测试
cmake -DBUILD_TESTS=OFF ..

# 不构建性能测试
cmake -DBUILD_BENCHMARKS=OFF ..

# 构建示例
cmake -DBUILD_EXAMPLES=ON ..

# 构建 C++23 模块示例（需要支持的环境）
cmake -DBUILD_MODULE_EXAMPLES=ON ..

# 安装到系统
sudo cmake --install .
```

### C++23 模块构建

模块构建需要满足以下条件：
- CMake >= 3.28
- 生成器为 Ninja 或 Visual Studio
- Clang 工具链需要 `clang-scan-deps`

```bash
# 使用 Ninja 生成器
cmake -S . -B build-mod -G Ninja -DBUILD_MODULE_EXAMPLES=ON
cmake --build build-mod --parallel

# 指定 Clang 编译器（macOS）
cmake -S . -B build-mod -G Ninja \
  -DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm@20/bin/clang++ \
  -DBUILD_MODULE_EXAMPLES=ON
cmake --build build-mod --target galay-mcp-modules --parallel
```

## 快速示例

### Stdio 服务器

创建一个简单的 MCP 服务器，提供加法工具：

```cpp
#include "galay-mcp/server/McpStdioServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"

using namespace galay::mcp;

int main() {
    McpStdioServer server;
    server.setServerInfo("my-server", "1.0.0");

    // 定义工具参数 Schema
    auto schema = SchemaBuilder()
        .addNumber("a", "First number", true)
        .addNumber("b", "Second number", true)
        .build();

    // 添加加法工具
    server.addTool("add", "Add two numbers", schema,
        [](const JsonElement& args) -> std::expected<JsonString, McpError> {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                return std::unexpected(McpError::invalidParams("Invalid arguments"));
            }

            auto aVal = obj["a"];
            auto bVal = obj["b"];
            if (aVal.error() || bVal.error()) {
                return std::unexpected(McpError::invalidParams("Missing parameters"));
            }

            double a = aVal.is_double() ? aVal.get_double().value()
                                        : static_cast<double>(aVal.get_int64().value());
            double b = bVal.is_double() ? bVal.get_double().value()
                                        : static_cast<double>(bVal.get_int64().value());

            JsonWriter writer;
            writer.StartObject();
            writer.Key("result");
            writer.Number(a + b);
            writer.EndObject();
            return writer.TakeString();
        }
    );

    // 启动服务器（阻塞）
    server.run();
    return 0;
}
```

### Stdio 客户端

连接到 MCP 服务器并调用工具：

```cpp
#include "galay-mcp/client/McpStdioClient.h"
#include <iostream>

using namespace galay::mcp;

int main() {
    McpStdioClient client;

    // 初始化连接
    auto init_result = client.initialize("my-client", "1.0.0");
    if (!init_result) {
        std::cerr << "Initialize failed: " << init_result.error().message() << '\n';
        return 1;
    }

    std::cout << "Connected to: " << client.getServerInfo().name << '\n';

    // 获取工具列表
    auto tools = client.listTools();
    if (tools) {
        std::cout << "Available tools:\n";
        for (const auto& tool : *tools) {
            std::cout << "  - " << tool.name << ": " << tool.description << '\n';
        }
    }

    // 调用工具
    JsonWriter argsWriter;
    argsWriter.StartObject();
    argsWriter.Key("a");
    argsWriter.Number(static_cast<int64_t>(10));
    argsWriter.Key("b");
    argsWriter.Number(static_cast<int64_t>(20));
    argsWriter.EndObject();

    auto result = client.callTool("add", argsWriter.TakeString());
    if (result) {
        std::cout << "Result: " << result.value() << '\n';
    } else {
        std::cerr << "Tool call failed: " << result.error().message() << '\n';
    }

    client.disconnect();
    return 0;
}
```

### 运行示例

```bash
# 编译
cd build
cmake --build . --parallel

# 通过管道连接服务器和客户端
./bin/test_stdio_server | ./bin/test_stdio_client
```

## HTTP 传输示例

### HTTP 服务器

```cpp
#include "galay-mcp/server/McpHttpServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"

using namespace galay::mcp;

int main() {
    McpHttpServer server("0.0.0.0", 8080);
    server.setServerInfo("http-server", "1.0.0");

    auto schema = SchemaBuilder()
        .addString("message", "Message to echo", true)
        .build();

    server.addTool("echo", "Echo a message", schema,
        [](const JsonElement& args, std::expected<JsonString, McpError>& result)
        -> kernel::Coroutine {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                result = std::unexpected(McpError::invalidParams("Invalid arguments"));
                co_return;
            }

            auto msgVal = obj["message"];
            if (msgVal.error()) {
                result = std::unexpected(McpError::invalidParams("Missing message"));
                co_return;
            }

            std::string msg;
            if (!JsonHelper::GetString(msgVal.value(), msg)) {
                result = std::unexpected(McpError::invalidParams("Invalid message type"));
                co_return;
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("echo");
            writer.String(msg);
            writer.EndObject();
            result = writer.TakeString();
        }
    );

    server.start();
    return 0;
}
```

### HTTP 客户端

```cpp
#include "galay-mcp/client/McpHttpClient.h"
#include "galay-kernel/kernel/Runtime.h"
#include <iostream>
#include <atomic>

using namespace galay::mcp;
using namespace galay::kernel;

struct RunState {
    std::atomic<bool> done{false};
};

Coroutine run(Runtime& runtime, RunState* state) {
    McpHttpClient client(runtime);

    // 连接
    co_await client.connect("http://127.0.0.1:8080/mcp");

    // 初始化
    std::expected<void, McpError> init_result;
    co_await client.initialize("http-client", "1.0.0", init_result);

    if (!init_result) {
        std::cerr << "Initialize failed\n";
        state->done = true;
        co_return;
    }

    // 调用工具
    JsonWriter argsWriter;
    argsWriter.StartObject();
    argsWriter.Key("message");
    argsWriter.String("Hello MCP!");
    argsWriter.EndObject();

    std::expected<JsonString, McpError> call_result;
    co_await client.callTool("echo", argsWriter.TakeString(), call_result);

    if (call_result) {
        std::cout << "Result: " << call_result.value() << '\n';
    }

    co_await client.disconnect();
    state->done = true;
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    RunState state;
    scheduler->spawn(run(runtime, &state));

    while (!state.done) {
        std::this_thread::sleep_for(std::chrono::milliseconds(50));
    }

    runtime.stop();
    return 0;
}
```

## 运行测试

```bash
cd build

# 运行 Stdio 测试
./bin/test_stdio_server | ./bin/test_stdio_client

# 运行 HTTP 测试（需要两个终端）
# 终端 1：启动服务器
./bin/test_http_server

# 终端 2：运行客户端
./bin/test_http_client http://127.0.0.1:8080/mcp
```

## 使用 C++23 模块

如果你的环境支持 C++23 模块，可以使用 `import` 代替 `#include`：

```cpp
import galay.mcp;

using namespace galay::mcp;

int main() {
    McpStdioServer server;
    // ... 其他代码
}
```

构建时需要启用模块支持：

```bash
cmake -S . -B build-mod -G Ninja -DBUILD_MODULE_EXAMPLES=ON
cmake --build build-mod --parallel
```

## 下一步

- [架构设计](01-架构设计.md) - 了解 Galay MCP 的架构和设计理念
- [API 参考](02-API参考.md) - 完整的 API 文档
- [使用指南](03-使用指南.md) - 详细的使用说明和最佳实践
- [示例代码](04-示例代码.md) - 更多实用示例
- [常见问题](05-常见问题.md) - 常见问题解答

## 获取帮助

- GitHub Issues: https://github.com/gzj-creator/galay-mcp/issues
- MCP 规范: https://modelcontextprotocol.io/
- Galay 框架: https://github.com/gzj-creator/galay-kernel
