# 03-使用指南

本文档提供 Galay MCP 的详细使用说明、最佳实践和常见场景。

## 选择传输方式

### Stdio vs HTTP

| 特性 | Stdio | HTTP |
|------|-------|------|
| 适用场景 | 进程间通信、命令行工具 | 网络服务、微服务架构 |
| 并发模型 | 同步阻塞 | 异步协程 |
| 连接方式 | 管道连接 | TCP 连接 |
| 调试难度 | 简单（直接查看输入输出） | 中等（需要抓包工具） |
| 性能 | 高（本地通信） | 中（网络开销） |
| 可扩展性 | 低（单进程） | 高（支持负载均衡） |

### 使用建议

**选择 Stdio 当**:
- 构建命令行工具
- 进程间通信
- 本地开发和测试
- 需要简单的部署

**选择 HTTP 当**:
- 构建网络服务
- 需要远程访问
- 需要负载均衡
- 需要与现有 HTTP 基础设施集成

## Stdio 使用指南

### 服务器端开发

#### 1. 基本设置

```cpp
#include "galay-mcp/server/McpStdioServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"

using namespace galay::mcp;

int main() {
    McpStdioServer server;

    // 设置服务器信息
    server.setServerInfo("my-service", "1.0.0");

    // 添加工具、资源、提示...

    // 启动服务器（阻塞）
    server.run();
    return 0;
}
```

#### 2. 添加工具

**简单工具**:

```cpp
auto schema = SchemaBuilder()
    .addString("text", "Text to process", true)
    .build();

server.addTool("uppercase", "Convert text to uppercase", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        std::string text;
        auto textVal = obj["text"];
        if (textVal.error() || !JsonHelper::GetString(textVal.value(), text)) {
            return std::unexpected(McpError::invalidParams("Missing text"));
        }

        // 转换为大写
        std::transform(text.begin(), text.end(), text.begin(), ::toupper);

        JsonWriter writer;
        writer.StartObject();
        writer.Key("result");
        writer.String(text);
        writer.EndObject();
        return writer.TakeString();
    }
);
```

**复杂工具（多参数）**:

```cpp
auto schema = SchemaBuilder()
    .addString("operation", "Operation type", true)
    .addNumber("x", "First operand", true)
    .addNumber("y", "Second operand", true)
    .build();

server.addTool("calculator", "Perform arithmetic operations", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        // 解析参数
        std::string op;
        auto opVal = obj["operation"];
        if (opVal.error() || !JsonHelper::GetString(opVal.value(), op)) {
            return std::unexpected(McpError::invalidParams("Missing operation"));
        }

        auto xVal = obj["x"];
        auto yVal = obj["y"];
        if (xVal.error() || yVal.error()) {
            return std::unexpected(McpError::invalidParams("Missing operands"));
        }

        double x = xVal.is_double() ? xVal.get_double().value()
                                    : static_cast<double>(xVal.get_int64().value());
        double y = yVal.is_double() ? yVal.get_double().value()
                                    : static_cast<double>(yVal.get_int64().value());

        // 执行操作
        double result;
        if (op == "add") {
            result = x + y;
        } else if (op == "subtract") {
            result = x - y;
        } else if (op == "multiply") {
            result = x * y;
        } else if (op == "divide") {
            if (y == 0) {
                return std::unexpected(McpError::invalidParams("Division by zero"));
            }
            result = x / y;
        } else {
            return std::unexpected(McpError::invalidParams("Unknown operation"));
        }

        JsonWriter writer;
        writer.StartObject();
        writer.Key("result");
        writer.Number(result);
        writer.EndObject();
        return writer.TakeString();
    }
);
```

#### 3. 添加资源

**静态资源**:

```cpp
server.addResource(
    "config://app",
    "Application Config",
    "Application configuration",
    "application/json",
    [](const std::string& uri) -> std::expected<std::string, McpError> {
        return R"({"version":"1.0","debug":true})";
    }
);
```

**文件资源**:

```cpp
server.addResource(
    "file:///data/users.json",
    "Users Database",
    "User information database",
    "application/json",
    [](const std::string& uri) -> std::expected<std::string, McpError> {
        std::ifstream file("data/users.json");
        if (!file) {
            return std::unexpected(McpError::internalError("File not found"));
        }

        std::string content((std::istreambuf_iterator<char>(file)),
                           std::istreambuf_iterator<char>());
        return content;
    }
);
```

**动态资源**:

```cpp
server.addResource(
    "system://status",
    "System Status",
    "Current system status",
    "application/json",
    [](const std::string& uri) -> std::expected<std::string, McpError> {
        // 获取系统状态
        auto cpuUsage = getCpuUsage();
        auto memUsage = getMemoryUsage();

        JsonWriter writer;
        writer.StartObject();
        writer.Key("cpu");
        writer.Number(cpuUsage);
        writer.Key("memory");
        writer.Number(memUsage);
        writer.Key("timestamp");
        writer.Number(std::time(nullptr));
        writer.EndObject();
        return writer.TakeString();
    }
);
```

#### 4. 添加提示

```cpp
auto args = PromptArgumentBuilder()
    .addArgument("language", "Programming language", true)
    .addArgument("difficulty", "Difficulty level", false)
    .build();

server.addPrompt("code_review", "Generate code review prompt", args,
    [](const std::string& name, const JsonElement& args)
    -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        std::string language;
        auto langVal = obj["language"];
        if (langVal.error() || !JsonHelper::GetString(langVal.value(), language)) {
            return std::unexpected(McpError::invalidParams("Missing language"));
        }

        std::string difficulty = "medium";
        auto diffVal = obj["difficulty"];
        if (!diffVal.error()) {
            JsonHelper::GetString(diffVal.value(), difficulty);
        }

        std::string prompt = "Review the following " + language +
                           " code (difficulty: " + difficulty + "):\n\n";

        JsonWriter writer;
        writer.StartObject();
        writer.Key("prompt");
        writer.String(prompt);
        writer.EndObject();
        return writer.TakeString();
    }
);
```

#### 5. 错误处理

```cpp
server.addTool("divide", "Divide two numbers", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        try {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                return std::unexpected(McpError::invalidParams("Invalid arguments"));
            }

            auto xVal = obj["x"];
            auto yVal = obj["y"];
            if (xVal.error() || yVal.error()) {
                return std::unexpected(McpError::invalidParams("Missing operands"));
            }

            double x = xVal.is_double() ? xVal.get_double().value()
                                        : static_cast<double>(xVal.get_int64().value());
            double y = yVal.is_double() ? yVal.get_double().value()
                                        : static_cast<double>(yVal.get_int64().value());

            if (y == 0) {
                return std::unexpected(McpError::invalidParams("Division by zero"));
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("result");
            writer.Number(x / y);
            writer.EndObject();
            return writer.TakeString();

        } catch (const std::exception& e) {
            return std::unexpected(McpError::internalError(e.what()));
        }
    }
);
```

### 客户端开发

#### 1. 基本连接

```cpp
#include "galay-mcp/client/McpStdioClient.h"
#include <iostream>

using namespace galay::mcp;

int main() {
    McpStdioClient client;

    // 初始化连接
    auto init_result = client.initialize("my-client", "1.0.0");
    if (!init_result) {
        std::cerr << "Failed to initialize: "
                  << init_result.error().message() << '\n';
        return 1;
    }

    std::cout << "Connected to: " << client.getServerInfo().name << '\n';

    // 使用客户端...

    client.disconnect();
    return 0;
}
```

#### 2. 调用工具

```cpp
// 构建参数
JsonWriter argsWriter;
argsWriter.StartObject();
argsWriter.Key("text");
argsWriter.String("hello world");
argsWriter.EndObject();

// 调用工具
auto result = client.callTool("uppercase", argsWriter.TakeString());
if (result) {
    std::cout << "Result: " << result.value() << '\n';
} else {
    std::cerr << "Error: " << result.error().message() << '\n';
}
```

#### 3. 读取资源

```cpp
// 列出所有资源
auto resources = client.listResources();
if (resources) {
    std::cout << "Available resources:\n";
    for (const auto& res : *resources) {
        std::cout << "  " << res.uri << " - " << res.name << '\n';
    }
}

// 读取特定资源
auto content = client.readResource("config://app");
if (content) {
    std::cout << "Config: " << content.value() << '\n';
}
```

#### 4. 获取提示

```cpp
// 列出所有提示
auto prompts = client.listPrompts();
if (prompts) {
    for (const auto& prompt : *prompts) {
        std::cout << prompt.name << ": " << prompt.description << '\n';
        for (const auto& arg : prompt.arguments) {
            std::cout << "  - " << arg.name << " ("
                      << (arg.required ? "required" : "optional") << ")\n";
        }
    }
}

// 获取提示
JsonWriter argsWriter;
argsWriter.StartObject();
argsWriter.Key("language");
argsWriter.String("C++");
argsWriter.Key("difficulty");
argsWriter.String("hard");
argsWriter.EndObject();

auto prompt = client.getPrompt("code_review", argsWriter.TakeString());
if (prompt) {
    std::cout << "Prompt: " << prompt.value() << '\n';
}
```

#### 5. 错误处理

```cpp
auto result = client.callTool("unknown_tool", "{}");
if (!result) {
    const auto& error = result.error();
    std::cerr << "Error " << error.code() << ": "
              << error.message() << '\n';

    if (!error.details().empty()) {
        std::cerr << "Details: " << error.details() << '\n';
    }

    // 根据错误码处理
    switch (error.code()) {
        case ErrorCodes::METHOD_NOT_FOUND:
            std::cerr << "Tool not found\n";
            break;
        case ErrorCodes::INVALID_PARAMS:
            std::cerr << "Invalid parameters\n";
            break;
        case ErrorCodes::INTERNAL_ERROR:
            std::cerr << "Server error\n";
            break;
    }
}
```

## HTTP 使用指南

### 服务器端开发

#### 1. 基本设置

```cpp
#include "galay-mcp/server/McpHttpServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"

using namespace galay::mcp;

int main() {
    // 创建服务器（监听 0.0.0.0:8080）
    McpHttpServer server("0.0.0.0", 8080);
    server.setServerInfo("http-service", "1.0.0");

    // 添加工具、资源、提示...

    // 启动服务器（非阻塞）
    server.start();

    // 保持运行
    std::cout << "Server running on http://0.0.0.0:8080/mcp\n";
    std::cout << "Press Enter to stop...\n";
    std::cin.get();

    server.stop();
    return 0;
}
```

#### 2. 添加异步工具

```cpp
auto schema = SchemaBuilder()
    .addString("url", "URL to fetch", true)
    .build();

server.addTool("fetch", "Fetch URL content", schema,
    [](const JsonElement& args, std::expected<JsonString, McpError>& result)
    -> kernel::Coroutine {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            result = std::unexpected(McpError::invalidParams("Invalid arguments"));
            co_return;
        }

        std::string url;
        auto urlVal = obj["url"];
        if (urlVal.error() || !JsonHelper::GetString(urlVal.value(), url)) {
            result = std::unexpected(McpError::invalidParams("Missing url"));
            co_return;
        }

        // 异步获取 URL 内容
        auto content = co_await fetchUrlAsync(url);

        JsonWriter writer;
        writer.StartObject();
        writer.Key("content");
        writer.String(content);
        writer.EndObject();
        result = writer.TakeString();
    }
);
```

#### 3. 添加异步资源

```cpp
server.addResource(
    "db://users",
    "Users Database",
    "User information from database",
    "application/json",
    [](const std::string& uri, std::expected<std::string, McpError>& result)
    -> kernel::Coroutine {
        // 异步查询数据库
        auto users = co_await queryDatabaseAsync("SELECT * FROM users");

        JsonWriter writer;
        writer.StartArray();
        for (const auto& user : users) {
            writer.StartObject();
            writer.Key("id");
            writer.Number(user.id);
            writer.Key("name");
            writer.String(user.name);
            writer.EndObject();
        }
        writer.EndArray();
        result = writer.TakeString();
    }
);
```

### 客户端开发

#### 1. 基本连接

```cpp
#include "galay-mcp/client/McpHttpClient.h"
#include "galay-kernel/kernel/Runtime.h"
#include <atomic>

using namespace galay::mcp;
using namespace galay::kernel;

struct RunState {
    std::atomic<bool> done{false};
};

Coroutine clientTask(Runtime& runtime, RunState* state) {
    McpHttpClient client(runtime);

    // 连接到服务器
    co_await client.connect("http://127.0.0.1:8080/mcp");

    if (!client.isConnected()) {
        std::cerr << "Failed to connect\n";
        state->done = true;
        co_return;
    }

    // 初始化
    std::expected<void, McpError> init_result;
    co_await client.initialize("http-client", "1.0.0", init_result);

    if (!init_result) {
        std::cerr << "Failed to initialize\n";
        state->done = true;
        co_return;
    }

    std::cout << "Connected to: " << client.getServerInfo().name << '\n';

    // 使用客户端...

    co_await client.disconnect();
    state->done = true;
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    if (!scheduler) {
        std::cerr << "Failed to get scheduler\n";
        return 1;
    }

    RunState state;
    scheduler->spawn(clientTask(runtime, &state));

    // 等待完成
    while (!state.done) {
        std::this_thread::sleep_for(std::chrono::milliseconds(50));
    }

    runtime.stop();
    return 0;
}
```

#### 2. 调用工具

```cpp
Coroutine callToolExample(McpHttpClient& client) {
    JsonWriter argsWriter;
    argsWriter.StartObject();
    argsWriter.Key("url");
    argsWriter.String("https://example.com");
    argsWriter.EndObject();

    std::expected<JsonString, McpError> result;
    co_await client.callTool("fetch", argsWriter.TakeString(), result);

    if (result) {
        std::cout << "Result: " << result.value() << '\n';
    } else {
        std::cerr << "Error: " << result.error().message() << '\n';
    }
}
```

## 最佳实践

### 1. Schema 设计

**使用描述性名称**:

```cpp
// 好
auto schema = SchemaBuilder()
    .addString("user_email", "User's email address", true)
    .addInteger("max_results", "Maximum number of results to return", false)
    .build();

// 不好
auto schema = SchemaBuilder()
    .addString("e", "Email", true)
    .addInteger("n", "Number", false)
    .build();
```

**提供详细描述**:

```cpp
auto schema = SchemaBuilder()
    .addString("query",
               "Search query string. Supports wildcards (*) and boolean operators (AND, OR, NOT)",
               true)
    .addInteger("limit",
                "Maximum number of results to return. Must be between 1 and 100. Default is 10",
                false)
    .build();
```

**使用枚举限制值**:

```cpp
auto schema = SchemaBuilder()
    .addEnum("sort_order",
             "Sort order for results",
             {"asc", "desc"},
             false)
    .addEnum("format",
             "Output format",
             {"json", "xml", "csv"},
             false)
    .build();
```

### 2. 错误处理

**提供详细错误信息**:

```cpp
if (value < 0) {
    return std::unexpected(McpError::invalidParams(
        "Value must be non-negative, got: " + std::to_string(value)
    ));
}

if (!fileExists(path)) {
    return std::unexpected(McpError::internalError(
        "File not found: " + path
    ));
}
```

**区分错误类型**:

```cpp
// 客户端错误（参数问题）
if (args.empty()) {
    return std::unexpected(McpError::invalidParams("Arguments required"));
}

// 服务器错误（内部问题）
if (!database.isConnected()) {
    return std::unexpected(McpError::internalError("Database connection lost"));
}

// 方法未找到
if (!toolExists(name)) {
    return std::unexpected(McpError::methodNotFound(name));
}
```

### 3. 参数验证

**完整验证**:

```cpp
server.addTool("search", "Search database", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        // 验证必需参数
        std::string query;
        auto queryVal = obj["query"];
        if (queryVal.error() || !JsonHelper::GetString(queryVal.value(), query)) {
            return std::unexpected(McpError::invalidParams("Missing or invalid query"));
        }

        if (query.empty()) {
            return std::unexpected(McpError::invalidParams("Query cannot be empty"));
        }

        // 验证可选参数
        int64_t limit = 10;  // 默认值
        auto limitVal = obj["limit"];
        if (!limitVal.error()) {
            if (!limitVal.is_int64()) {
                return std::unexpected(McpError::invalidParams("Limit must be an integer"));
            }
            limit = limitVal.get_int64().value();
            if (limit < 1 || limit > 100) {
                return std::unexpected(McpError::invalidParams("Limit must be between 1 and 100"));
            }
        }

        // 执行搜索...
    }
);
```

### 4. 资源 URI 设计

**使用清晰的 URI 方案**:

```cpp
// 文件系统
"file:///path/to/file.txt"

// 数据库
"db://table_name/record_id"

// 配置
"config://section/key"

// 系统信息
"system://cpu/usage"
"system://memory/available"

// 自定义方案
"myapp://resource_type/resource_id"
```

### 5. 性能优化

**缓存静态数据**:

```cpp
class MyServer {
private:
    std::string m_cachedConfig;

public:
    void setupResources(McpStdioServer& server) {
        // 预加载配置
        m_cachedConfig = loadConfig();

        server.addResource("config://app", "Config", "application/json",
            [this](const std::string& uri) -> std::expected<std::string, McpError> {
                return m_cachedConfig;  // 返回缓存
            }
        );
    }
};
```

**避免重复解析**:

```cpp
// 不好：每次都解析
server.addTool("process", "Process data", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        auto doc = JsonDocument::Parse(someJsonString);  // 重复解析
        // ...
    }
);

// 好：复用解析结果
server.addTool("process", "Process data", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        // args 已经是解析好的 JsonElement
        JsonObject obj;
        JsonHelper::GetObject(args, obj);
        // ...
    }
);
```

### 6. 线程安全

**Stdio 服务器**:

```cpp
// 工具处理函数可以安全地访问共享数据（使用互斥锁）
class SharedData {
private:
    std::mutex m_mutex;
    std::map<std::string, std::string> m_data;

public:
    std::string get(const std::string& key) {
        std::lock_guard<std::mutex> lock(m_mutex);
        return m_data[key];
    }

    void set(const std::string& key, const std::string& value) {
        std::lock_guard<std::mutex> lock(m_mutex);
        m_data[key] = value;
    }
};

SharedData sharedData;

server.addTool("get_data", "Get data", schema,
    [&sharedData](const JsonElement& args) -> std::expected<JsonString, McpError> {
        // 线程安全访问
        auto value = sharedData.get("key");
        // ...
    }
);
```

**HTTP 服务器**:

```cpp
// 协程环境下，避免使用阻塞的互斥锁
// 使用无锁数据结构或协程友好的同步原语
```

## 调试技巧

### 1. 启用日志

```cpp
// 在工具处理函数中添加日志
server.addTool("debug_tool", "Debug tool", schema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        std::cerr << "[DEBUG] Tool called with args: ";
        std::string rawArgs;
        JsonHelper::GetRawJson(args, rawArgs);
        std::cerr << rawArgs << '\n';

        // 处理逻辑...

        std::cerr << "[DEBUG] Tool completed\n";
        return result;
    }
);
```

### 2. 查看原始消息

**Stdio 模式**:

```bash
# 保存输入输出到文件
./server 2>server.log | tee client_input.log | ./client | tee server_input.log
```

**HTTP 模式**:

```bash
# 使用 curl 测试
curl -X POST http://127.0.0.1:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
```

### 3. 单元测试

```cpp
#include <cassert>

void testToolHandler() {
    // 构建测试参数
    JsonWriter argsWriter;
    argsWriter.StartObject();
    argsWriter.Key("x");
    argsWriter.Number(10);
    argsWriter.Key("y");
    argsWriter.Number(20);
    argsWriter.EndObject();

    auto argsDoc = JsonDocument::Parse(argsWriter.TakeString());
    assert(argsDoc.has_value());

    // 调用处理函数
    auto result = myToolHandler(argsDoc.value().Root());

    // 验证结果
    assert(result.has_value());

    auto resultDoc = JsonDocument::Parse(result.value());
    assert(resultDoc.has_value());

    JsonObject obj;
    assert(JsonHelper::GetObject(resultDoc.value().Root(), obj));

    auto resultVal = obj["result"];
    assert(!resultVal.error());
    assert(resultVal.is_int64());
    assert(resultVal.get_int64().value() == 30);
}
```

## 下一步

- [示例代码](04-示例代码.md) - 更多实用示例
- [常见问题](05-常见问题.md) - 常见问题解答
