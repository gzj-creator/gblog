# 04-示例代码

本文档提供 Galay MCP 的完整示例代码，涵盖常见使用场景。

## 目录

- [Stdio 服务器示例](#stdio-服务器示例)
- [Stdio 客户端示例](#stdio-客户端示例)
- [HTTP 服务器示例](#http-服务器示例)
- [HTTP 客户端示例](#http-客户端示例)
- [工具实现示例](#工具实现示例)
- [资源管理示例](#资源管理示例)
- [提示生成示例](#提示生成示例)

## Stdio 服务器示例

### 基础服务器

```cpp
#include "galay-mcp/server/McpStdioServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"
#include <iostream>

using namespace galay::mcp;

int main() {
    McpStdioServer server;
    server.setServerInfo("example-server", "1.0.0");

    // 添加加法工具
    auto addSchema = SchemaBuilder()
        .addNumber("a", "First number", true)
        .addNumber("b", "Second number", true)
        .build();

    server.addTool("add", "Add two numbers", addSchema,
        [](const JsonElement& args) -> std::expected<JsonString, McpError> {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                return std::unexpected(McpError::invalidParams("Invalid arguments"));
            }

            auto aVal = obj["a"];
            auto bVal = obj["b"];
            if (aVal.error() || bVal.error()) {
                return std::unexpected(McpError::invalidParams("Missing parameters"));
            }

            double a = aVal.is_double() ? aVal.get_double().value()
                                        : static_cast<double>(aVal.get_int64().value());
            double b = bVal.is_double() ? bVal.get_double().value()
                                        : static_cast<double>(bVal.get_int64().value());

            JsonWriter writer;
            writer.StartObject();
            writer.Key("result");
            writer.Number(a + b);
            writer.EndObject();
            return writer.TakeString();
        }
    );

    // 添加字符串连接工具
    auto concatSchema = SchemaBuilder()
        .addString("str1", "First string", true)
        .addString("str2", "Second string", true)
        .build();

    server.addTool("concat", "Concatenate two strings", concatSchema,
        [](const JsonElement& args) -> std::expected<JsonString, McpError> {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                return std::unexpected(McpError::invalidParams("Invalid arguments"));
            }

            std::string str1, str2;
            auto str1Val = obj["str1"];
            auto str2Val = obj["str2"];

            if (str1Val.error() || !JsonHelper::GetString(str1Val.value(), str1) ||
                str2Val.error() || !JsonHelper::GetString(str2Val.value(), str2)) {
                return std::unexpected(McpError::invalidParams("Missing or invalid parameters"));
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("result");
            writer.String(str1 + str2);
            writer.EndObject();
            return writer.TakeString();
        }
    );

    std::cerr << "Server started. Waiting for requests...\n";
    server.run();
    return 0;
}
```

### 带资源的服务器

```cpp
#include "galay-mcp/server/McpStdioServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"
#include <fstream>
#include <sstream>

using namespace galay::mcp;

int main() {
    McpStdioServer server;
    server.setServerInfo("resource-server", "1.0.0");

    // 添加文件资源
    server.addResource(
        "file:///config.json",
        "Configuration",
        "Application configuration file",
        "application/json",
        [](const std::string& uri) -> std::expected<std::string, McpError> {
            std::ifstream file("config.json");
            if (!file) {
                return std::unexpected(McpError::internalError("File not found"));
            }
            std::stringstream buffer;
            buffer << file.rdbuf();
            return buffer.str();
        }
    );

    // 添加动态资源
    server.addResource(
        "system://status",
        "System Status",
        "Current system status",
        "application/json",
        [](const std::string& uri) -> std::expected<std::string, McpError> {
            JsonWriter writer;
            writer.StartObject();
            writer.Key("timestamp");
            writer.Number(std::time(nullptr));
            writer.Key("status");
            writer.String("running");
            writer.EndObject();
            return writer.TakeString();
        }
    );

    server.run();
    return 0;
}
```

### 带提示的服务器

```cpp
#include "galay-mcp/server/McpStdioServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"

using namespace galay::mcp;

int main() {
    McpStdioServer server;
    server.setServerInfo("prompt-server", "1.0.0");

    // 添加代码审查提示
    auto reviewArgs = PromptArgumentBuilder()
        .addArgument("language", "Programming language", true)
        .addArgument("difficulty", "Code difficulty level", false)
        .build();

    server.addPrompt("code_review", "Generate code review prompt", reviewArgs,
        [](const std::string& name, const JsonElement& args)
        -> std::expected<JsonString, McpError> {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                return std::unexpected(McpError::invalidParams("Invalid arguments"));
            }

            std::string language;
            auto langVal = obj["language"];
            if (langVal.error() || !JsonHelper::GetString(langVal.value(), language)) {
                return std::unexpected(McpError::invalidParams("Missing language"));
            }

            std::string difficulty = "medium";
            auto diffVal = obj["difficulty"];
            if (!diffVal.error()) {
                JsonHelper::GetString(diffVal.value(), difficulty);
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("description");
            writer.String("Code review prompt");
            writer.Key("messages");
            writer.StartArray();
            writer.StartObject();
            writer.Key("role");
            writer.String("user");
            writer.Key("content");
            writer.StartObject();
            writer.Key("type");
            writer.String("text");
            writer.Key("text");
            writer.String("Review the following " + language + " code (difficulty: " + difficulty + ")");
            writer.EndObject();
            writer.EndObject();
            writer.EndArray();
            writer.EndObject();
            return writer.TakeString();
        }
    );

    server.run();
    return 0;
}
```

## Stdio 客户端示例

### 基础客户端

```cpp
#include "galay-mcp/client/McpStdioClient.h"
#include <iostream>

using namespace galay::mcp;

int main() {
    McpStdioClient client;

    // 初始化连接
    auto init_result = client.initialize("example-client", "1.0.0");
    if (!init_result) {
        std::cerr << "Initialize failed: " << init_result.error().message() << '\n';
        return 1;
    }

    std::cout << "Connected to: " << client.getServerInfo().name << '\n';

    // 列出工具
    auto tools = client.listTools();
    if (tools) {
        std::cout << "Available tools:\n";
        for (const auto& tool : *tools) {
            std::cout << "  - " << tool.name << ": " << tool.description << '\n';
        }
    }

    // 调用工具
    JsonWriter argsWriter;
    argsWriter.StartObject();
    argsWriter.Key("a");
    argsWriter.Number(10);
    argsWriter.Key("b");
    argsWriter.Number(20);
    argsWriter.EndObject();

    auto result = client.callTool("add", argsWriter.TakeString());
    if (result) {
        std::cout << "Result: " << result.value() << '\n';
    } else {
        std::cerr << "Error: " << result.error().message() << '\n';
    }

    client.disconnect();
    return 0;
}
```

### 完整功能客户端

```cpp
#include "galay-mcp/client/McpStdioClient.h"
#include <iostream>

using namespace galay::mcp;

void printError(const McpError& error) {
    std::cerr << "Error " << error.code() << ": " << error.message() << '\n';
    if (!error.details().empty()) {
        std::cerr << "Details: " << error.details() << '\n';
    }
}

int main() {
    McpStdioClient client;

    // 1. 初始化
    std::cout << "=== Initializing ===\n";
    auto init_result = client.initialize("full-client", "1.0.0");
    if (!init_result) {
        printError(init_result.error());
        return 1;
    }
    std::cout << "Server: " << client.getServerInfo().name << '\n';

    // 2. 列出并调用工具
    std::cout << "\n=== Tools ===\n";
    auto tools = client.listTools();
    if (tools) {
        for (const auto& tool : *tools) {
            std::cout << tool.name << ": " << tool.description << '\n';
        }

        // 调用第一个工具
        if (!tools->empty()) {
            JsonWriter argsWriter;
            argsWriter.StartObject();
            argsWriter.Key("a");
            argsWriter.Number(5);
            argsWriter.Key("b");
            argsWriter.Number(3);
            argsWriter.EndObject();

            auto result = client.callTool(tools->front().name, argsWriter.TakeString());
            if (result) {
                std::cout << "Result: " << result.value() << '\n';
            }
        }
    }

    // 3. 列出并读取资源
    std::cout << "\n=== Resources ===\n";
    auto resources = client.listResources();
    if (resources) {
        for (const auto& res : *resources) {
            std::cout << res.uri << ": " << res.name << '\n';

            // 读取资源
            auto content = client.readResource(res.uri);
            if (content) {
                std::cout << "Content: " << content.value() << '\n';
            }
        }
    }

    // 4. 列出并获取提示
    std::cout << "\n=== Prompts ===\n";
    auto prompts = client.listPrompts();
    if (prompts) {
        for (const auto& prompt : *prompts) {
            std::cout << prompt.name << ": " << prompt.description << '\n';
            for (const auto& arg : prompt.arguments) {
                std::cout << "  - " << arg.name << " ("
                          << (arg.required ? "required" : "optional") << ")\n";
            }
        }
    }

    // 5. Ping
    std::cout << "\n=== Ping ===\n";
    auto ping_result = client.ping();
    if (ping_result) {
        std::cout << "Ping successful\n";
    }

    client.disconnect();
    return 0;
}
```

## HTTP 服务器示例

### 基础 HTTP 服务器

```cpp
#include "galay-mcp/server/McpHttpServer.h"
#include "galay-mcp/common/McpSchemaBuilder.h"
#include <iostream>

using namespace galay::mcp;
using namespace galay::kernel;

int main() {
    McpHttpServer server("0.0.0.0", 8080);
    server.setServerInfo("http-server", "1.0.0");

    // 添加 echo 工具
    auto echoSchema = SchemaBuilder()
        .addString("message", "Message to echo", true)
        .build();

    server.addTool("echo", "Echo a message", echoSchema,
        [](const JsonElement& args, std::expected<JsonString, McpError>& result)
        -> Coroutine {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                result = std::unexpected(McpError::invalidParams("Invalid arguments"));
                co_return;
            }

            std::string message;
            auto msgVal = obj["message"];
            if (msgVal.error() || !JsonHelper::GetString(msgVal.value(), message)) {
                result = std::unexpected(McpError::invalidParams("Missing message"));
                co_return;
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("echo");
            writer.String(message);
            writer.EndObject();
            result = writer.TakeString();
        }
    );

    // 添加计算工具
    auto calcSchema = SchemaBuilder()
        .addString("operation", "Operation: add, subtract, multiply, divide", true)
        .addNumber("x", "First operand", true)
        .addNumber("y", "Second operand", true)
        .build();

    server.addTool("calculate", "Perform arithmetic operations", calcSchema,
        [](const JsonElement& args, std::expected<JsonString, McpError>& result)
        -> Coroutine {
            JsonObject obj;
            if (!JsonHelper::GetObject(args, obj)) {
                result = std::unexpected(McpError::invalidParams("Invalid arguments"));
                co_return;
            }

            std::string op;
            auto opVal = obj["operation"];
            if (opVal.error() || !JsonHelper::GetString(opVal.value(), op)) {
                result = std::unexpected(McpError::invalidParams("Missing operation"));
                co_return;
            }

            auto xVal = obj["x"];
            auto yVal = obj["y"];
            if (xVal.error() || yVal.error()) {
                result = std::unexpected(McpError::invalidParams("Missing operands"));
                co_return;
            }

            double x = xVal.is_double() ? xVal.get_double().value()
                                        : static_cast<double>(xVal.get_int64().value());
            double y = yVal.is_double() ? yVal.get_double().value()
                                        : static_cast<double>(yVal.get_int64().value());

            double res;
            if (op == "add") {
                res = x + y;
            } else if (op == "subtract") {
                res = x - y;
            } else if (op == "multiply") {
                res = x * y;
            } else if (op == "divide") {
                if (y == 0) {
                    result = std::unexpected(McpError::invalidParams("Division by zero"));
                    co_return;
                }
                res = x / y;
            } else {
                result = std::unexpected(McpError::invalidParams("Unknown operation"));
                co_return;
            }

            JsonWriter writer;
            writer.StartObject();
            writer.Key("result");
            writer.Number(res);
            writer.EndObject();
            result = writer.TakeString();
        }
    );

    server.start();
    std::cout << "HTTP Server running on http://0.0.0.0:8080/mcp\n";
    std::cout << "Press Enter to stop...\n";
    std::cin.get();
    server.stop();

    return 0;
}
```

## HTTP 客户端示例

### 基础 HTTP 客户端

```cpp
#include "galay-mcp/client/McpHttpClient.h"
#include "galay-kernel/kernel/Runtime.h"
#include <iostream>
#include <atomic>

using namespace galay::mcp;
using namespace galay::kernel;

struct RunState {
    std::atomic<bool> done{false};
};

Coroutine clientTask(Runtime& runtime, RunState* state) {
    McpHttpClient client(runtime);

    // 连接
    co_await client.connect("http://127.0.0.1:8080/mcp");
    if (!client.isConnected()) {
        std::cerr << "Failed to connect\n";
        state->done = true;
        co_return;
    }

    // 初始化
    std::expected<void, McpError> init_result;
    co_await client.initialize("http-client", "1.0.0", init_result);
    if (!init_result) {
        std::cerr << "Initialize failed\n";
        state->done = true;
        co_return;
    }

    std::cout << "Connected to: " << client.getServerInfo().name << '\n';

    // 调用 echo 工具
    JsonWriter echoArgs;
    echoArgs.StartObject();
    echoArgs.Key("message");
    echoArgs.String("Hello from HTTP client!");
    echoArgs.EndObject();

    std::expected<JsonString, McpError> echo_result;
    co_await client.callTool("echo", echoArgs.TakeString(), echo_result);
    if (echo_result) {
        std::cout << "Echo result: " << echo_result.value() << '\n';
    }

    // 调用计算工具
    JsonWriter calcArgs;
    calcArgs.StartObject();
    calcArgs.Key("operation");
    calcArgs.String("multiply");
    calcArgs.Key("x");
    calcArgs.Number(6);
    calcArgs.Key("y");
    calcArgs.Number(7);
    calcArgs.EndObject();

    std::expected<JsonString, McpError> calc_result;
    co_await client.callTool("calculate", calcArgs.TakeString(), calc_result);
    if (calc_result) {
        std::cout << "Calculate result: " << calc_result.value() << '\n';
    }

    co_await client.disconnect();
    state->done = true;
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    if (!scheduler) {
        std::cerr << "Failed to get scheduler\n";
        return 1;
    }

    RunState state;
    scheduler->spawn(clientTask(runtime, &state));

    while (!state.done) {
        std::this_thread::sleep_for(std::chrono::milliseconds(50));
    }

    runtime.stop();
    return 0;
}
```

## 工具实现示例

### 文件操作工具

```cpp
auto fileSchema = SchemaBuilder()
    .addString("path", "File path", true)
    .addString("operation", "Operation: read, write, delete", true)
    .addString("content", "Content for write operation", false)
    .build();

server.addTool("file_ops", "File operations", fileSchema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        std::string path, operation;
        auto pathVal = obj["path"];
        auto opVal = obj["operation"];

        if (pathVal.error() || !JsonHelper::GetString(pathVal.value(), path) ||
            opVal.error() || !JsonHelper::GetString(opVal.value(), operation)) {
            return std::unexpected(McpError::invalidParams("Missing parameters"));
        }

        JsonWriter writer;
        writer.StartObject();

        if (operation == "read") {
            std::ifstream file(path);
            if (!file) {
                return std::unexpected(McpError::internalError("File not found"));
            }
            std::string content((std::istreambuf_iterator<char>(file)),
                               std::istreambuf_iterator<char>());
            writer.Key("content");
            writer.String(content);
        } else if (operation == "write") {
            std::string content;
            auto contentVal = obj["content"];
            if (contentVal.error() || !JsonHelper::GetString(contentVal.value(), content)) {
                return std::unexpected(McpError::invalidParams("Missing content"));
            }
            std::ofstream file(path);
            if (!file) {
                return std::unexpected(McpError::internalError("Cannot write file"));
            }
            file << content;
            writer.Key("status");
            writer.String("written");
        } else if (operation == "delete") {
            if (std::remove(path.c_str()) != 0) {
                return std::unexpected(McpError::internalError("Cannot delete file"));
            }
            writer.Key("status");
            writer.String("deleted");
        } else {
            return std::unexpected(McpError::invalidParams("Unknown operation"));
        }

        writer.EndObject();
        return writer.TakeString();
    }
);
```

### 数据库查询工具

```cpp
auto querySchema = SchemaBuilder()
    .addString("query", "SQL query", true)
    .addInteger("limit", "Result limit", false)
    .build();

server.addTool("db_query", "Execute database query", querySchema,
    [](const JsonElement& args) -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        std::string query;
        auto queryVal = obj["query"];
        if (queryVal.error() || !JsonHelper::GetString(queryVal.value(), query)) {
            return std::unexpected(McpError::invalidParams("Missing query"));
        }

        int64_t limit = 100;
        auto limitVal = obj["limit"];
        if (!limitVal.error() && limitVal.is_int64()) {
            limit = limitVal.get_int64().value();
        }

        // 执行查询（示例）
        // auto results = executeQuery(query, limit);

        JsonWriter writer;
        writer.StartObject();
        writer.Key("rows");
        writer.StartArray();
        // 添加结果行...
        writer.EndArray();
        writer.Key("count");
        writer.Number(0);
        writer.EndObject();
        return writer.TakeString();
    }
);
```

## 资源管理示例

### 动态资源列表

```cpp
class ResourceManager {
private:
    std::map<std::string, std::string> m_resources;
    std::mutex m_mutex;

public:
    void addResource(const std::string& uri, const std::string& content) {
        std::lock_guard<std::mutex> lock(m_mutex);
        m_resources[uri] = content;
    }

    std::expected<std::string, McpError> getResource(const std::string& uri) {
        std::lock_guard<std::mutex> lock(m_mutex);
        auto it = m_resources.find(uri);
        if (it == m_resources.end()) {
            return std::unexpected(McpError::internalError("Resource not found"));
        }
        return it->second;
    }
};

// 使用
ResourceManager manager;
manager.addResource("data://users", "{\"users\":[]}");

server.addResource("data://users", "Users", "User data", "application/json",
    [&manager](const std::string& uri) -> std::expected<std::string, McpError> {
        return manager.getResource(uri);
    }
);
```

## 提示生成示例

### 代码生成提示

```cpp
auto codeGenArgs = PromptArgumentBuilder()
    .addArgument("language", "Programming language", true)
    .addArgument("task", "Task description", true)
    .addArgument("style", "Coding style", false)
    .build();

server.addPrompt("code_gen", "Generate code generation prompt", codeGenArgs,
    [](const std::string& name, const JsonElement& args)
    -> std::expected<JsonString, McpError> {
        JsonObject obj;
        if (!JsonHelper::GetObject(args, obj)) {
            return std::unexpected(McpError::invalidParams("Invalid arguments"));
        }

        std::string language, task;
        auto langVal = obj["language"];
        auto taskVal = obj["task"];

        if (langVal.error() || !JsonHelper::GetString(langVal.value(), language) ||
            taskVal.error() || !JsonHelper::GetString(taskVal.value(), task)) {
            return std::unexpected(McpError::invalidParams("Missing parameters"));
        }

        std::string style = "clean";
        auto styleVal = obj["style"];
        if (!styleVal.error()) {
            JsonHelper::GetString(styleVal.value(), style);
        }

        std::string promptText = "Write " + language + " code to " + task +
                                ". Use " + style + " coding style.";

        JsonWriter writer;
        writer.StartObject();
        writer.Key("description");
        writer.String("Code generation");
        writer.Key("messages");
        writer.StartArray();
        writer.StartObject();
        writer.Key("role");
        writer.String("user");
        writer.Key("content");
        writer.StartObject();
        writer.Key("type");
        writer.String("text");
        writer.Key("text");
        writer.String(promptText);
        writer.EndObject();
        writer.EndObject();
        writer.EndArray();
        writer.EndObject();
        return writer.TakeString();
    }
);
```

## 运行示例

### Stdio 模式

```bash
# 编译
cd build
cmake --build . --parallel

# 运行（通过管道连接）
./bin/T2-StdioServer | ./bin/T1-StdioClient
```

### HTTP 模式

```bash
# 终端 1：启动服务器
./bin/T4-HttpServer

# 终端 2：运行客户端
./bin/T3-HttpClient http://127.0.0.1:8080/mcp

# 或使用 curl 测试
curl -X POST http://127.0.0.1:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
```

## 下一步

- [常见问题](05-常见问题.md) - 常见问题解答
- [API 参考](02-API参考.md) - 完整的 API 文档
- [使用指南](03-使用指南.md) - 详细的使用说明
