# galay-mongo 架构设计

## 1. 设计目标

`galay-mongo` 是一个基于 `galay-kernel` 的 C++23 MongoDB 客户端库，目标是：

- 提供同步（阻塞）与异步（协程）两套 API。
- 统一 BSON/OP_MSG 协议栈，避免 sync/async 两套协议实现分叉。
- 用 `std::expected` 统一错误模型，减少异常依赖。
- 认证能力对齐：sync/async 均支持 `SCRAM-SHA-256`。

## 2. 分层与目录

| 目录 | 职责 |
|---|---|
| `galay-mongo/base` | 基础类型：`MongoConfig`、`MongoError`、`MongoValue`、`MongoLogger` |
| `galay-mongo/protocol` | BSON 编解码、Mongo `OP_MSG` 协议封装、同步连接收发 |
| `galay-mongo/sync` | `MongoClient` 同步会话 API 与同步 SCRAM 认证 |
| `galay-mongo/async` | `AsyncMongoClient` 协程 API、awaitable 状态机、异步 SCRAM 认证 |
| `galay-mongo/module` | C++23 模块接口 `galay.mongo` |
| `example` | sync/async 示例程序（include/import） |
| `test` | 协议与会话测试 |
| `benchmark` | sync/async 基准程序 |

## 3. 核心数据模型

### 3.1 BSON 值模型

- `MongoValue`：`null/bool/int32/int64/double/string/binary/document/array`
- `MongoDocument`：有序键值容器（`std::vector<pair<string, MongoValue>>`）
- `MongoArray`：`std::vector<MongoValue>`
- `MongoReply`：命令返回包装，提供 `ok()/errorCode()/errorMessage()`

### 3.2 BSON 类型支持

- 编码支持：`Double/String/Document/Array/Binary/Bool/Null/Int32/Int64`
- 解码额外支持：`ObjectId(0x07)`、`DateTime(0x09)`、`Timestamp(0x11)`
- 映射方式：
  - `ObjectId` 解码为 12 字节 `Binary`
  - `DateTime` / `Timestamp` 解码为 `int64`

## 4. 协议与执行流程

### 4.1 同步流程（`MongoClient`）

1. TCP 连接（`protocol::Connection`）。
2. 发送 `hello`（携带 `client.driver/os/application`）。
3. 若配置用户名密码，执行 SCRAM-SHA-256：`saslStart -> saslContinue -> (可选)saslContinue`。
4. 业务命令统一走 `OP_MSG`（`executeCommand`）。
5. 接收路径使用 `RingBuffer + readv`；当单条消息大于 ring 容量时，自动切换到分段直读 bridge，避免大包失败。
6. 返回 `std::expected<MongoReply, MongoError>`。

### 4.2 异步流程（`AsyncMongoClient`）

1. `MongoConnectAwaitable` 负责 connect + hello + (可选) SCRAM。
2. `MongoCommandAwaitable` 负责 send/recv + OP_MSG 解析。
3. 通过 `RingBuffer + readv/writev` 做收发缓冲。
4. awaitable 内部状态机统一处理 `send/recv/parse` 与错误映射。

## 5. SCRAM-SHA-256 认证要点

- 客户端 nonce 用 OpenSSL `RAND_bytes` 生成。
- 认证计算链：
  - `PBKDF2-HMAC-SHA256`
  - `HMAC(SaltedPassword, "Client Key")`
  - `SHA256(ClientKey)`
  - `HMAC(StoredKey, AuthMessage)`
  - `ClientProof = ClientKey XOR ClientSignature`
- 服务端签名会被校验，不匹配立即失败。
- `conversationId` 同时兼容 `int32/int64/double` 回包形态（异步实现）。

## 6. sync/async 能力对齐

| 能力 | Sync (`MongoClient`) | Async (`AsyncMongoClient`) |
|---|---|---|
| connect + hello | 支持 | 支持 |
| `command` | 支持 | 支持 |
| `ping` | 支持 | 支持 |
| SCRAM-SHA-256 | 支持 | 支持 |
| 错误模型 | `std::expected` | `std::expected` |
| logger 封装 | N/A | `MongoLogger` + `setLogger(...)` |

## 7. 错误传播设计

- 连接/发送/接收/超时映射到 `MongoErrorType`。
- 服务器命令错误保留 `serverCode` 与消息文本。
- sync/async 统一使用 `MongoError::message()` 输出可读诊断。

## 8. 目前边界

- 重点覆盖命令式调用链（`ping/find/insert/update/delete` 及通用 `command`）。
- 当前 benchmark 基于 `ping` 场景，适合对比框架开销与并发能力。
- 高级特性（连接池、事务、游标流式消费）可在后续版本扩展。
