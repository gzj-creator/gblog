# galay-mongo 使用指南

## 1. 依赖与构建

### 1.1 依赖

- CMake 3.20+
- C++23 编译器
- OpenSSL
- spdlog
- galay-kernel

### 1.2 构建

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build -j
```

常用选项：

- `-DGALAY_MONGO_BUILD_TESTS=ON/OFF`
- `-DGALAY_MONGO_BUILD_EXAMPLES=ON/OFF`
- `-DGALAY_MONGO_BUILD_BENCHMARKS=ON/OFF`
- `-DGALAY_MONGO_BUILD_SHARED_LIBS=ON/OFF`
- `-DGALAY_MONGO_ENABLE_IMPORT_COMPILATION=ON/OFF`
- `-DGALAY_MONGO_BUILD_MODULE_EXAMPLES=ON/OFF`

## 2. MongoDB 端准备

你提供的 `mongod.conf` 关键点：

- `bindIp: 0.0.0.0`
- `port: 27017`
- `security:` 段未启用

这意味着当前实例是“未开启鉴权”模式，客户端连接时可以不提供用户名密码。

如果后续开启鉴权，请在客户端同时配置：

- `username`
- `password`
- `auth_database`（通常是 `admin`）

## 3. 环境变量配置

`example/test/benchmark` 均支持：

- `GALAY_MONGO_HOST`
- `GALAY_MONGO_PORT`
- `GALAY_MONGO_DB`
- `GALAY_MONGO_USER`
- `GALAY_MONGO_PASSWORD`
- `GALAY_MONGO_AUTH_DB`
- `GALAY_MONGO_HELLO_DB`
- `GALAY_MONGO_TCP_NODELAY`（`1/0`）
- `GALAY_MONGO_RECV_BUFFER_SIZE`
- `GALAY_MONGO_ASYNC_SEND_TIMEOUT_MS`
- `GALAY_MONGO_ASYNC_RECV_TIMEOUT_MS`
- `GALAY_MONGO_ASYNC_BUFFER_SIZE`
- `GALAY_MONGO_ASYNC_PIPELINE_RESERVE`
- `GALAY_MONGO_LOGGER_NAME`

benchmark 额外支持：

- `GALAY_MONGO_BENCH_TOTAL`
- `GALAY_MONGO_BENCH_CONCURRENCY`

## 4. 示例运行

### 4.1 同步 ping 示例

```bash
GALAY_MONGO_HOST=140.143.142.251 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=admin \
./build/example/E1-SyncPing-Include
```

预期输出：`Mongo ping OK`

### 4.2 异步 ping 示例

```bash
GALAY_MONGO_HOST=140.143.142.251 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=admin \
./build/example/E2-AsyncPing-Include
```

预期输出：`Async Mongo ping OK`

### 4.3 同步 CRUD 示例

```bash
GALAY_MONGO_HOST=140.143.142.251 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=admin \
./build/example/E3-SyncCrud-Include
```

预期输出：`Sync CRUD example OK`

### 4.4 异步 Pipeline 示例

```bash
GALAY_MONGO_HOST=140.143.142.251 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=admin \
./build/example/E4-AsyncPipeline-Include
```

预期输出：`Async pipeline example OK`

### 4.5 异步命令式 CRUD 示例

```bash
GALAY_MONGO_HOST=140.143.142.251 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=admin \
./build/example/E5-AsyncCommandCrud-Include
```

预期输出：`Async command CRUD example OK`

模块 import 版示例（若开启并生效）：

```bash
./build/example/E1-SyncPing-Import
./build/example/E2-AsyncPing-Import
./build/example/E3-SyncCrud-Import
./build/example/E4-AsyncPipeline-Import
./build/example/E5-AsyncCommandCrud-Import
```

## 5. 代码使用

### 5.1 同步会话

```cpp
#include "galay-mongo/sync/MongoClient.h"

using namespace galay::mongo;

int main() {
    MongoClient session;

    MongoConfig cfg;
    cfg.host = "140.143.142.251";
    cfg.port = 27017;
    cfg.database = "admin";

    auto conn = session.connect(cfg);
    if (!conn) return 1;

    auto ping = session.ping("admin");
    if (!ping) return 1;

    session.close();
    return 0;
}
```

### 5.2 异步会话

```cpp
Coroutine run(galay::kernel::IOScheduler* scheduler, galay::mongo::MongoConfig cfg) {
    galay::mongo::AsyncMongoClient client(scheduler);

    std::expected<bool, galay::mongo::MongoError> conn = co_await client.connect(cfg);
    if (!conn) co_return;

    std::expected<galay::mongo::MongoReply, galay::mongo::MongoError> rsp =
        co_await client.ping(cfg.database);
    if (!rsp) co_return;

    co_await client.close();
}
```

### 5.3 异步 Pipeline（单连接多 in-flight）

```cpp
Coroutine runPipeline(galay::kernel::IOScheduler* scheduler, galay::mongo::MongoConfig cfg) {
    galay::mongo::AsyncMongoClient client(scheduler);

    std::expected<bool, galay::mongo::MongoError> conn = co_await client.connect(cfg);
    if (!conn) co_return;

    std::vector<galay::mongo::MongoDocument> commands;
    galay::mongo::MongoDocument c1;
    c1.append("ping", int32_t(1));
    commands.push_back(std::move(c1));
    galay::mongo::MongoDocument c2;
    c2.append("ping", int32_t(1));
    commands.push_back(std::move(c2));

    std::expected<std::vector<galay::mongo::MongoPipelineResponse>, galay::mongo::MongoError> result =
        co_await client.pipeline(cfg.database, std::move(commands));
    if (!result) co_return;

    for (const auto& item : *result) {
        if (item.ok()) {
            // 成功：item.reply 有值
        } else {
            // 失败：item.error 有值
        }
    }

    co_await client.close();
}
```

## 6. 测试运行

```bash
cmake -S . -B build -DGALAY_MONGO_BUILD_TESTS=ON
cmake --build build -j

./build/test/T1-BsonProtocol
./build/test/T2-SyncMongoClient
./build/test/T3-AsyncMongoPipeline
./build/test/T4-SyncMongoFunctional
./build/test/T5-AsyncMongoFunctional
./build/test/T7-SyncLargeMessageBridge
./build/test/T6-AuthCompatibility
```

`T2` 到 `T5`、`T7` 需要可访问 MongoDB。

`T6-AuthCompatibility` 的行为：

- 同时设置 `GALAY_MONGO_USER` 和 `GALAY_MONGO_PASSWORD` 时：执行 sync + async 鉴权兼容测试。
- 两者都不设置时：自动 `SKIPPED` 并返回成功。

## 7. Benchmark 使用

```bash
cmake -S . -B build -DGALAY_MONGO_BUILD_BENCHMARKS=ON
cmake --build build -j

./build/benchmark/B1-SyncPingBench 20000 100 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 20000 100 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 20000 100 140.143.142.251 27017 admin --fanout=2
```

参数顺序：

`[total] [concurrency] [host] [port] [db] [user] [password] [auth_db]`

`B2-AsyncPingBench` 额外支持：

- `--fanout=N`（或环境变量 `GALAY_MONGO_BENCH_ASYNC_FANOUT`）
- 说明：`worker_count = concurrency * fanout`，可用于提升高 RTT 场景下吞吐，但会增加连接数和尾延迟

完整性能数据见 `docs/04-性能测试.md`。

## 8. 常见问题

### 8.1 `Operation not permitted` 连接失败

通常是当前执行环境禁止外网访问，不是 MongoDB 协议错误。请在允许网络访问的环境执行。

### 8.2 认证失败

确认：

- `username/password` 是否同时填写
- `auth_database` 是否正确
- 服务端是否已开启 `security.authorization`

### 8.3 异步日志太多

`AsyncMongoClient` 默认会输出连接成功日志。压测场景可通过 `setLogger(...)` 注入更高日志级别 logger。
