# galay-mongo 性能测试

## 1. 测试目标

- 验证 `galay-mongo` 在真实 MongoDB 服务上的连通性与稳定性。
- 对比 sync/async 在相同 `ping` 负载下的吞吐与延迟。
- 输出可复现实验命令，作为后续回归基线。

## 2. 测试时间与环境

- 测试日期：2026-02-15
- 客户端系统：Darwin Kernel 24.6.0 (arm64)
- 构建模式：Release
- MongoDB 地址：`140.143.142.251:27017`
- 数据库：`admin`
- 鉴权：未提供用户名密码（服务端当前未启用鉴权）

## 3. 测试程序

- `B1-SyncPingBench`：同步会话 + 多线程并发
- `B2-AsyncPingBench`：异步客户端 + 协程并发

构建：

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DGALAY_MONGO_BUILD_BENCHMARKS=ON
cmake --build build --parallel
```

执行命令：

```bash
./build/benchmark/B1-SyncPingBench 3000 10 140.143.142.251 27017 admin
./build/benchmark/B1-SyncPingBench 5000 50 140.143.142.251 27017 admin
./build/benchmark/B1-SyncPingBench 8000 100 140.143.142.251 27017 admin

./build/benchmark/B2-AsyncPingBench 3000 10 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 5000 50 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 8000 100 140.143.142.251 27017 admin
```

## 4. 测试结果

### 4.1 Sync (`B1-SyncPingBench`)

| total | concurrency | Success | Errors | Duration(ms) | Requests/sec | p50(ms) | p95(ms) | p99(ms) |
|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 3000 | 10 | 3000 | 0 | 9171 | 327.118 | 30.2662 | 34.9130 | 35.9737 |
| 5000 | 50 | 5000 | 0 | 3183 | 1570.850 | 31.6150 | 35.5040 | 36.6973 |
| 8000 | 100 | 8000 | 0 | 2618 | 3055.770 | 32.6711 | 36.3128 | 38.4885 |

### 4.2 Async (`B2-AsyncPingBench`)

| total | concurrency | Success | Errors | Duration(ms) | Requests/sec | p50(ms) | p95(ms) | p99(ms) |
|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| 3000 | 10 | 3000 | 0 | 9674 | 310.110 | 31.7652 | 34.3525 | 35.9416 |
| 5000 | 50 | 5000 | 0 | 3280 | 1524.390 | 31.2850 | 34.7462 | 36.7312 |
| 8000 | 100 | 8000 | 0 | 2807 | 2850.020 | 31.9926 | 35.8539 | 37.5235 |

### 4.3 对比摘要

| 并发 | Sync RPS | Async RPS | RPS 差值 (Async-Sync) |
|---:|---:|---:|---:|
| 10 | 327.118 | 310.110 | -17.008 |
| 50 | 1570.850 | 1524.390 | -46.460 |
| 100 | 3055.770 | 2850.020 | -205.750 |

结论：

- 两种实现都在 6 组用例中实现 `Errors=0`。
- 延迟分位接近，p50/p95/p99 都在同一数量级。
- 该轮测试下 sync 吞吐略高于 async；主要原因是 async 版本每协程连接的调度与日志开销更明显。

## 5. 连通性验证（Example）

同一环境下 example 验证：

- `E1-SyncPing-Include`：`Mongo ping OK`
- `E2-AsyncPing-Include`：`Async Mongo ping OK`

说明核心链路可用：`connect -> hello -> (可选 SCRAM) -> command(ping)`。

## 6. 结果解读与后续优化

建议后续压测继续补充：

- 认证开启场景（`SCRAM-SHA-256`）对吞吐影响。
- 更真实命令集（`find/insert/update/delete`）而不只 `ping`。
- async 压测时降低日志等级，减少连接成功日志对输出与开销的影响。

## 7. 优化补充（2026-02-16）

本轮优化项：

- 异步/同步连接启用 `TCP_NODELAY`。
- benchmark 热路径减少原子操作开销（每 worker 本地累计后合并）。
- `B2` 新增 `--fanout=N`（或 `GALAY_MONGO_BENCH_ASYNC_FANOUT`），用于高 RTT 场景扩展有效连接数。

同环境同参数对比（`total=8000, concurrency=100`）：

| 模式 | fanout | Requests/sec | p50(ms) | p95(ms) | p99(ms) | Errors |
|---|---:|---:|---:|---:|---:|---:|
| Async | 1 | 2832.86 | 32.5001 | 35.8309 | 37.1864 | 0 |
| Async | 2 | 3484.32 | 33.6484 | 39.9428 | 275.76 | 0 |

结论：

- `fanout=2` 吞吐约提升 `22.98%`。
- 尾延迟（特别 p99）会显著上升，适合“追求吞吐优先”的压测场景。

## 8. 继续优化补充（2026-02-16，第二轮）

本轮新增优化项：

- `MongoCommandAwaitable` 支持复用 `arm()`（修复复用路径编译问题）。
- 新增 async `ping` 快路径：缓存同库 `ping` 请求模板，仅替换 `requestId`，避免重复 BSON 编码。
- `B2-AsyncPingBench` 热路径改为调用 `client.ping(...)`，减少压测程序自身构造开销。

复测命令（串行执行，避免互相干扰）：

```bash
./build/benchmark/B2-AsyncPingBench 8000 100 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 8000 100 140.143.142.251 27017 admin --fanout=2
```

结果：

| 模式 | fanout | Requests/sec | p50(ms) | p95(ms) | p99(ms) | Errors |
|---|---:|---:|---:|---:|---:|---:|
| Async | 1 | 2856.12 | 31.9413 | 36.0207 | 37.7531 | 0 |
| Async | 2 | 3379.81 | 34.0630 | 40.6976 | 277.4580 | 0 |

结论：

- `fanout=1` 吞吐与上一轮基线接近，保持稳定。
- `fanout=2` 仍能明显提升吞吐，但高分位延迟上升，需按场景取舍。
- 当前远端压测已更接近 RTT/服务端处理能力上限，后续若继续提升 QPS，建议引入“单连接多 in-flight 命令”模式。

## 9. 同步 Connection RingBuffer 改造回归（2026-02-16，第三轮）

本轮新增优化项：

- 同步 `protocol::Connection` 接收路径由线性 `vector + memmove` 改为 `RingBuffer + readv`。
- 新增大报文 bridge：当单条消息大于 ring 容量时，自动切换到“ring 已收数据 + socket 分段直读”。
- 保持原有错误语义（超时/断连/协议错误）不变。

回归命令：

```bash
./build/benchmark/B1-SyncPingBench 8000 100 140.143.142.251 27017 admin
./build/benchmark/B2-AsyncPingBench 8000 100 140.143.142.251 27017 admin
```

结果：

| 程序 | total | concurrency | Success | Errors | Duration(ms) | Requests/sec | p50(ms) | p95(ms) | p99(ms) |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| B1-SyncPingBench | 8000 | 100 | 8000 | 0 | 5335 | 1499.53 | 62.6260 | 92.5460 | 180.1990 |
| B2-AsyncPingBench | 8000 | 100 | 8000 | 0 | 5702 | 1403.02 | 64.3875 | 90.7435 | 104.7210 |

说明：

- 本轮主要目标是验证改造后功能/稳定性，无错误返回（`Errors=0`）达成。
- 该组数据受远端实例当时负载和网络抖动影响较大，绝对值建议仅作同环境当时快照，不直接与历史峰值做结论性对比。
