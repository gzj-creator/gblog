# 05-快速开始

## 依赖

- Galay 内部依赖（构建必需 + 联调推荐）：
  - [galay-kernel](https://github.com/gzj-creator/galay-kernel)（构建必需）
  - [galay-utils](https://github.com/gzj-creator/galay-utils)（推荐）
  - [galay-http](https://github.com/gzj-creator/galay-http)（推荐）
- 支持 C++23 的编译器（推荐 GCC 13+、Clang 16+）
- CMake 3.20+
- OpenSSL
- spdlog
- MongoDB 4.0+（推荐 5.0+）

## 依赖安装

### macOS / Homebrew

```bash
brew install cmake spdlog openssl mongodb-community
```

### Ubuntu / Debian

```bash
sudo apt-get update
sudo apt-get install -y cmake g++ libspdlog-dev libssl-dev mongodb
```

## 拉取与编译

```bash
git clone https://github.com/gzj-creator/galay-kernel.git
git clone https://github.com/gzj-creator/galay-utils.git
git clone https://github.com/gzj-creator/galay-http.git
git clone https://github.com/gzj-creator/galay-mongo.git
cd galay-mongo
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel
```

仅单独构建 `galay-mongo` 时，最小内部依赖为 `galay-kernel`。

## CMake 开关

- `GALAY_MONGO_BUILD_TESTS`：是否构建测试
- `GALAY_MONGO_BUILD_EXAMPLES`：是否构建示例
- `GALAY_MONGO_BUILD_BENCHMARKS`：是否构建性能测试
- `GALAY_MONGO_BUILD_SHARED_LIBS`：构建共享库或静态库
- `GALAY_MONGO_ENABLE_IMPORT_COMPILATION`：是否启用 import 编译路径
- `GALAY_MONGO_BUILD_MODULE_EXAMPLES`：是否构建 import 版示例

说明：import 编译自动检测工具链，当前仅 `Linux + CMake >= 3.28 + Ninja/Visual Studio + GCC >= 14` 会生效。
模块接口文件统一使用 `.cppm`（当前为 `galay-mongo/module/galay.mongo.cppm`）。
Clang 路径会检测 `clang-scan-deps`，当前默认不启用 Clang import 编译路径。

## 运行测试

测试程序读取以下环境变量：

- `GALAY_MONGO_HOST`
- `GALAY_MONGO_PORT`
- `GALAY_MONGO_DB`
- `GALAY_MONGO_USER`
- `GALAY_MONGO_PASSWORD`
- `GALAY_MONGO_AUTH_DB`

运行协议测试（无需 MongoDB）：

```bash
./build/test/T1-BsonProtocol
```

运行同步客户端测试：

```bash
GALAY_MONGO_HOST=127.0.0.1 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=test \
./build/test/T2-SyncMongoClient
```

运行异步客户端测试：

```bash
GALAY_MONGO_HOST=127.0.0.1 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=test \
./build/test/T3-AsyncMongoPipeline
```

运行功能测试：

```bash
GALAY_MONGO_HOST=127.0.0.1 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=test \
./build/test/T4-SyncMongoFunctional

GALAY_MONGO_HOST=127.0.0.1 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=test \
./build/test/T5-AsyncMongoFunctional
```

运行认证测试（需要配置用户名密码）：

```bash
GALAY_MONGO_HOST=127.0.0.1 \
GALAY_MONGO_PORT=27017 \
GALAY_MONGO_DB=test \
GALAY_MONGO_USER=admin \
GALAY_MONGO_PASSWORD=password \
GALAY_MONGO_AUTH_DB=admin \
./build/test/T6-AuthCompatibility
```

## 运行示例

示例位于 `examples/`，包含 include/import 两个版本：

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DGALAY_MONGO_BUILD_EXAMPLES=ON
cmake --build build --parallel

./build/examples/E1-SyncPing-Include
./build/examples/E2-AsyncPing-Include
./build/examples/E3-SyncCrud-Include
./build/examples/E4-AsyncPipeline-Include
./build/examples/E5-AsyncCommandCrud-Include
```

尝试构建 import 版本：

```bash
cmake -S . -B build-import \
  -DCMAKE_BUILD_TYPE=Release \
  -DGALAY_MONGO_BUILD_EXAMPLES=ON \
  -DGALAY_MONGO_ENABLE_IMPORT_COMPILATION=ON \
  -DGALAY_MONGO_BUILD_MODULE_EXAMPLES=ON
cmake --build build-import --parallel
```

## 同步最小示例

```cpp
#include "galay-mongo/sync/MongoClient.h"
using namespace galay::mongo;

int main() {
    MongoClient session;

    MongoConfig cfg;
    cfg.host = "127.0.0.1";
    cfg.port = 27017;
    cfg.database = "test";

    auto ok = session.connect(cfg);
    if (!ok) {
        std::cerr << "connect failed: " << ok.error().message() << '\n';
        return 1;
    }

    auto ping = session.ping("test");
    if (!ping) {
        std::cerr << "ping failed: " << ping.error().message() << '\n';
        session.close();
        return 1;
    }

    std::cout << "Mongo ping OK\n";
    session.close();
    return 0;
}
```

## 异步最小示例

```cpp
#include <atomic>
#include <chrono>
#include <expected>
#include <iostream>
#include <thread>
#include <galay-kernel/kernel/Runtime.h>

#if defined(__cpp_modules) && __cpp_modules >= 201907L
import galay.mongo;
#else
#include "galay-mongo/async/AsyncMongoClient.h"
#endif

using namespace galay::kernel;
using namespace galay::mongo;

struct State {
    std::atomic<bool> done{false};
};

Coroutine app(IOScheduler* scheduler, State* state) {
    AsyncMongoClient client(scheduler);

    MongoConfig cfg;
    cfg.host = "127.0.0.1";
    cfg.port = 27017;
    cfg.database = "test";

    std::expected<bool, MongoError> conn = co_await client.connect(cfg);
    if (!conn) {
        std::cerr << "connect failed: " << conn.error().message() << '\n';
        state->done.store(true, std::memory_order_release);
        co_return;
    }

    std::expected<MongoReply, MongoError> rsp = co_await client.ping("test");
    if (!rsp) {
        std::cerr << "ping failed: " << rsp.error().message() << '\n';
        co_await client.close();
        state->done.store(true, std::memory_order_release);
        co_return;
    }

    std::cout << "Async Mongo ping OK\n";
    co_await client.close();
    state->done.store(true, std::memory_order_release);
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    if (!scheduler) return 1;

    State state;
    scheduler->spawn(app(scheduler, &state));

    using namespace std::chrono_literals;
    while (!state.done.load(std::memory_order_acquire)) {
        std::this_thread::sleep_for(50ms);
    }

    runtime.stop();
    return 0;
}
```

## 常见问题

### 编译错误：找不到头文件

确保 CMake 能找到 `galay-kernel` 等依赖。可通过 `CMAKE_PREFIX_PATH` 指定：

```bash
cmake -S . -B build -DCMAKE_PREFIX_PATH="/path/to/galay-kernel;/path/to/galay-utils"
```

### 链接错误：undefined reference

检查是否链接了必要的库：

```cmake
target_link_libraries(your_target PRIVATE galay-mongo galay-kernel OpenSSL::SSL spdlog::spdlog)
```

### 运行时错误：连接失败

1. 检查 MongoDB 服务是否运行
2. 确认主机、端口、数据库名正确
3. 检查防火墙和网络连接
4. 查看 MongoDB 服务端日志

### import 编译失败

当前 import 编译路径要求：

- Linux 系统
- CMake >= 3.28
- Ninja 或 Visual Studio 生成器
- GCC >= 14

不满足条件时会自动降级到 include 路径。

## 下一步

- 查看 [API 参考](02-API参考.md) 了解完整接口
- 查看 [示例代码](06-示例代码.md) 学习常见用法
- 查看 [架构设计](01-架构设计.md) 理解内部实现
- 查看 [高级主题](07-高级主题.md) 了解性能优化和最佳实践
