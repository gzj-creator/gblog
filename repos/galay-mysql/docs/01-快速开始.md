# 快速开始

## 依赖

- 支持 C++23 的编译器（推荐 GCC 13+、Clang 16+）
- CMake 3.20+
- OpenSSL
- spdlog
- [galay-kernel](https://github.com/gzj-creator/galay)
- MySQL 5.7+ / 8.0+

## 拉取与编译

```bash
git clone https://github.com/gzj-creator/galay-mysql.git
cd galay-mysql
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build -j
```

## CMake 开关

- `GALAY_MYSQL_BUILD_TESTS`：是否构建测试
- `GALAY_MYSQL_BUILD_EXAMPLES`：是否构建示例
- `GALAY_MYSQL_BUILD_SHARED_LIBS`：构建共享库或静态库
- `GALAY_MYSQL_ENABLE_IMPORT_COMPILATION`：是否启用 import 编译路径
- `GALAY_MYSQL_BUILD_MODULE_EXAMPLES`：是否构建 import 版示例

说明：import 编译自动检测工具链，当前仅 `Linux + CMake >= 3.28 + Ninja/Visual Studio + GCC >= 14` 会生效。
模块接口文件统一使用 `.cppm`（当前为 `galay-mysql/module/galay.mysql.cppm`）。
Clang 路径会检测 `clang-scan-deps`，当前默认不启用 Clang import 编译路径。
旧开关 `GALAY_MYSQL_BUILD_IMPORT_EXAMPLES` 仍兼容，但已废弃。

## 运行测试

测试程序读取以下环境变量：

- `GALAY_MYSQL_HOST`
- `GALAY_MYSQL_PORT`
- `GALAY_MYSQL_USER`
- `GALAY_MYSQL_PASSWORD`
- `GALAY_MYSQL_DB`

运行异步测试：

```bash
GALAY_MYSQL_HOST=127.0.0.1 \
GALAY_MYSQL_PORT=3306 \
GALAY_MYSQL_USER=root \
GALAY_MYSQL_PASSWORD=password \
GALAY_MYSQL_DB=test \
./build/test/T3-AsyncMysqlClient
```

运行同步测试：

```bash
GALAY_MYSQL_HOST=127.0.0.1 \
GALAY_MYSQL_PORT=3306 \
GALAY_MYSQL_USER=root \
GALAY_MYSQL_PASSWORD=password \
GALAY_MYSQL_DB=test \
./build/test/T4-SyncMysqlClient
```

## 运行示例

示例位于 `example/`，包含 include/import 两个版本：

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DGALAY_MYSQL_BUILD_EXAMPLES=ON
cmake --build build -j

./build/example/E1-AsyncQuery-Include
./build/example/E2-SyncQuery-Include
./build/example/E3-AsyncPool-Include
./build/example/E4-SyncPreparedTx-Include
```

尝试构建 import 版本：

```bash
cmake -S . -B build-import \
  -DCMAKE_BUILD_TYPE=Release \
  -DGALAY_MYSQL_BUILD_EXAMPLES=ON \
  -DGALAY_MYSQL_ENABLE_IMPORT_COMPILATION=ON \
  -DGALAY_MYSQL_BUILD_MODULE_EXAMPLES=ON
cmake --build build-import -j
```

## 异步最小示例

```cpp
#include <atomic>
#include <chrono>
#include <expected>
#include <iostream>
#include <optional>
#include <thread>
#include <galay-kernel/kernel/Runtime.h>

#if defined(__cpp_modules) && __cpp_modules >= 201907L
import galay.mysql;
#else
#include "galay-mysql/async/AsyncMysqlClient.h"
#endif

using namespace galay::kernel;
using namespace galay::mysql;

struct State {
    std::atomic<bool> done{false};
};

Coroutine app(IOScheduler* scheduler, State* state) {
    AsyncMysqlClient client(scheduler);

    auto& conn_aw = client.connect("127.0.0.1", 3306, "root", "password", "test");
    std::expected<std::optional<bool>, MysqlError> conn_res;
    do {
        conn_res = co_await conn_aw;
        if (!conn_res) {
            std::cerr << "connect failed: " << conn_res.error().message() << '\n';
            state->done.store(true, std::memory_order_release);
            co_return;
        }
    } while (!conn_res->has_value());

    auto& query_aw = client.query("SELECT 1");
    std::expected<std::optional<MysqlResultSet>, MysqlError> query_res;
    do {
        query_res = co_await query_aw;
        if (!query_res) {
            std::cerr << "query failed: " << query_res.error().message() << '\n';
            co_await client.close();
            state->done.store(true, std::memory_order_release);
            co_return;
        }
    } while (!query_res->has_value());

    const MysqlResultSet& rs = query_res->value();
    if (rs.rowCount() > 0) {
        std::cout << "SELECT 1 => " << rs.row(0).getString(0) << '\n';
    }

    co_await client.close();
    state->done.store(true, std::memory_order_release);
}

int main() {
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    if (!scheduler) return 1;

    State state;
    scheduler->spawn(app(scheduler, &state));

    using namespace std::chrono_literals;
    while (!state.done.load(std::memory_order_acquire)) {
        std::this_thread::sleep_for(50ms);
    }

    runtime.stop();
    return 0;
}
```

## 同步最小示例

```cpp
#include <iostream>

#if defined(__cpp_modules) && __cpp_modules >= 201907L
import galay.mysql;
#else
#include "galay-mysql/sync/MysqlClient.h"
#endif

using namespace galay::mysql;

int main() {
    MysqlClient session;

    MysqlConfig cfg;
    cfg.host = "127.0.0.1";
    cfg.port = 3306;
    cfg.username = "root";
    cfg.password = "password";
    cfg.database = "test";
    cfg.connect_timeout_ms = 5000;

    auto conn = session.connect(cfg);
    if (!conn) {
        std::cerr << "connect failed: " << conn.error().message() << '\n';
        return 1;
    }

    auto res = session.query("SELECT id, name FROM users LIMIT 5");
    if (!res) {
        std::cerr << "query failed: " << res.error().message() << '\n';
        session.close();
        return 1;
    }

    for (size_t i = 0; i < res->rowCount(); ++i) {
        std::cout << res->row(i).getString(0) << " "
                  << res->row(i).getString(1) << '\n';
    }

    session.close();
    return 0;
}
```
