# 快速开始

## 项目简介

galay-redis 是基于 C++20 协程的异步 Redis 客户端库，属于 galay 生态的一部分。主要特性：

- 全异步协程 API，所有操作支持 `.timeout()` 超时控制
- 支持 String、Hash、List、Set、Sorted Set、Pub/Sub 等完整命令集
- Pipeline 批处理，百万级 QPS
- 连接池、主从读写分离、Cluster 集群路由
- 统一的 `std::expected` 错误处理

## 编译

```bash
cd build
cmake ..
make -j4
```

## 基本用法

```cpp
#include "galay-redis/async/RedisClient.h"
#include <galay-kernel/kernel/Runtime.h>

using namespace galay::redis;
using namespace galay::kernel;

Coroutine example(IOScheduler* scheduler)
{
    RedisClient client(scheduler);

    // 连接
    auto conn = co_await client.connect("127.0.0.1", 6379);
    if (!conn) {
        std::cerr << "Connect failed: " << conn.error().message() << std::endl;
        co_return;
    }

    // SET
    co_await client.set("name", "Alice");

    // GET（带 5 秒超时）
    auto result = co_await client.get("name").timeout(std::chrono::seconds(5));
    if (result && result.value()) {
        auto& values = result.value().value();
        if (!values.empty() && values[0].isString()) {
            std::cout << "name = " << values[0].toString() << std::endl;
        }
    }

    co_await client.close();
}

int main()
{
    Runtime runtime;
    runtime.start();

    auto* scheduler = runtime.getNextIOScheduler();
    scheduler->spawn(example(scheduler));

    std::this_thread::sleep_for(std::chrono::seconds(5));
    runtime.stop();
    return 0;
}
```

## 连接方式

```cpp
// 参数方式
co_await client.connect("127.0.0.1", 6379, "username", "password");

// URL 方式
co_await client.connect("redis://:password@127.0.0.1:6379/0");

// 连接也支持超时
co_await client.connect("127.0.0.1", 6379).timeout(std::chrono::seconds(3));
```

## 超时控制

所有操作返回的 Awaitable 都支持 `.timeout()`：

```cpp
// 单命令超时
auto r = co_await client.get("key").timeout(std::chrono::seconds(5));

// Pipeline 超时
auto r = co_await client.pipeline(commands).timeout(std::chrono::seconds(10));

// 连接池获取连接超时
auto r = co_await pool.acquire().timeout(std::chrono::seconds(2));

// 拓扑客户端超时
auto r = co_await cluster.executeByKeyAuto(key, "GET", {key})
                         .timeout(std::chrono::seconds(5));
```

## 错误处理

所有命令返回 `std::expected<std::optional<std::vector<RedisValue>>, RedisError>`：

```cpp
auto result = co_await client.get("key").timeout(std::chrono::seconds(5));

if (!result) {
    // 失败
    auto& error = result.error();
    switch (error.type()) {
        case REDIS_ERROR_TYPE_TIMEOUT_ERROR:
            std::cout << "超时" << std::endl;
            break;
        case REDIS_ERROR_TYPE_CONNECTION_CLOSED:
            std::cout << "连接已关闭" << std::endl;
            break;
        case REDIS_ERROR_TYPE_NETWORK_ERROR:
            std::cout << "网络错误: " << error.message() << std::endl;
            break;
        default:
            std::cout << "错误: " << error.message() << std::endl;
            break;
    }
    co_return;
}

// 成功
if (result.value()) {
    auto& values = result.value().value();
    // 使用 values...
}
```

### 错误类型

| 错误类型 | 说明 |
|---------|------|
| `REDIS_ERROR_TYPE_TIMEOUT_ERROR` | 操作超时 |
| `REDIS_ERROR_TYPE_CONNECTION_CLOSED` | 连接已关闭 |
| `REDIS_ERROR_TYPE_SEND_ERROR` | 发送失败 |
| `REDIS_ERROR_TYPE_RECV_ERROR` | 接收失败 |
| `REDIS_ERROR_TYPE_PARSE_ERROR` | 协议解析错误 |
| `REDIS_ERROR_TYPE_NETWORK_ERROR` | 网络错误 |
| `REDIS_ERROR_TYPE_INTERNAL_ERROR` | 内部错误 |

## API 速览

### String

```cpp
client.get(key)
client.set(key, value)
client.setex(key, seconds, value)
client.del(key)
client.exists(key)
client.incr(key)
client.decr(key)
```

### Hash

```cpp
client.hget(key, field)
client.hset(key, field, value)
client.hdel(key, field)
client.hgetAll(key)
```

### List

```cpp
client.lpush(key, value)
client.rpush(key, value)
client.lpop(key)
client.rpop(key)
client.llen(key)
client.lrange(key, start, stop)
```

### Set

```cpp
client.sadd(key, member)
client.srem(key, member)
client.smembers(key)
client.scard(key)
```

### Sorted Set

```cpp
client.zadd(key, score, member)
client.zrem(key, member)
client.zrange(key, start, stop)
client.zscore(key, member)
```

### Pub/Sub

```cpp
co_await sub.subscribe("channel");
co_await pub.publish("channel", "message");
auto msg = co_await sub.receive();
```

### Pipeline

```cpp
std::vector<std::vector<std::string>> commands = {
    {"SET", "k1", "v1"},
    {"SET", "k2", "v2"},
    {"GET", "k1"},
    {"GET", "k2"},
};
auto result = co_await client.pipeline(commands);
```

### RedisValue 类型

```cpp
// 类型检查
value.isNull()    value.isString()   value.isInteger()
value.isArray()   value.isError()    value.isDouble()
value.isBool()    value.isMap()

// 取值
value.toString()  value.toInteger()  value.toArray()
value.toDouble()  value.toBool()     value.toMap()
```

## 运行测试

```bash
# 功能测试
./build/test/test_redis_client_timeout

# 性能测试
./build/test/test_redis_client_benchmark 10 100

# Pipeline 性能测试
./build/test/test_redis_client_benchmark 20 5000 pipeline 100
```
