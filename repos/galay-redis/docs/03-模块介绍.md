# 03-模块介绍

## 项目结构

```text
galay-redis/
├── base/                       # 基础类型
│   ├── RedisValue.h/cc         # Redis 值类型封装
│   ├── RedisError.h            # 错误类型定义
│   └── RedisLog.h              # 日志工具
├── protocol/                   # 协议层
│   └── RedisProtocol.h/cc      # RESP2/RESP3 编解码
├── async/                      # 异步客户端
│   ├── RedisClient.h/cc        # 核心客户端
│   ├── RedisConnectionPool.h/cc # 连接池
│   └── RedisTopologyClient.h/cc # 拓扑客户端（主从/集群）
└── test/                       # 测试
    ├── test_redis_client_timeout.cc
    ├── test_redis_client_benchmark.cc
    └── ...
```

## RedisClient — 核心客户端

头文件：`async/RedisClient.h`

RedisClient 是最核心的模块，封装了与 Redis 服务器的异步通信。一个 RedisClient 实例对应一条 TCP 连接。

### 关键类

| 类 | 职责 |
|----|------|
| `RedisClient` | 管理连接和命令发送，提供 get/set/hget 等高层 API |
| `RedisClientAwaitable` | 单命令的协程 Awaitable，继承 `TimeoutSupport` |
| `RedisPipelineAwaitable` | Pipeline 批量命令的 Awaitable，继承 `TimeoutSupport` |
| `RedisConnectAwaitable` | 连接/认证/选库的 Awaitable |

### 命令覆盖

- String: GET, SET, SETEX, DEL, EXISTS, INCR, DECR
- Hash: HGET, HSET, HDEL, HGETALL
- List: LPUSH, RPUSH, LPOP, RPOP, LLEN, LRANGE
- Set: SADD, SREM, SMEMBERS, SCARD
- Sorted Set: ZADD, ZREM, ZRANGE, ZSCORE
- Pub/Sub: PUBLISH, SUBSCRIBE, UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE
- 通用: `execute(cmd, args)` 可执行任意命令

### 线程安全

单个 RedisClient 实例不是线程安全的。多线程场景下，每个线程/协程应使用独立的 RedisClient，或通过连接池获取连接。

---

## RedisConnectionPool — 连接池

头文件：`async/RedisConnectionPool.h`

提供线程安全的连接池管理，支持连接复用、自动扩缩容、健康检查。

### 关键类

| 类 | 职责 |
|----|------|
| `RedisConnectionPool` | 连接池主体，管理连接的创建、获取、归还、销毁 |
| `PooledConnection` | 池化连接的包装 |
| `ScopedConnection` | RAII 风格的连接管理，离开作用域自动归还 |
| `PoolInitializeAwaitable` | 初始化连接池的 Awaitable |
| `PoolAcquireAwaitable` | 获取连接的 Awaitable |

### 配置项

```cpp
struct ConnectionPoolConfig
{
    std::string host = "127.0.0.1";
    int32_t port = 6379;
    std::string username, password;
    int32_t db_index = 0;

    size_t min_connections = 2;       // 最小连接数
    size_t max_connections = 10;      // 最大连接数
    size_t initial_connections = 2;   // 初始连接数

    std::chrono::milliseconds acquire_timeout = std::chrono::seconds(5);
    std::chrono::milliseconds idle_timeout = std::chrono::minutes(5);
    std::chrono::milliseconds connect_timeout = std::chrono::seconds(3);

    bool enable_health_check = true;
    std::chrono::milliseconds health_check_interval = std::chrono::seconds(30);

    bool enable_auto_reconnect = true;
    int max_reconnect_attempts = 3;

    bool validate_on_acquire = false;  // 获取时验证（有性能开销）
    bool validate_on_return = false;   // 归还时验证
};
```

### 统计信息

通过 `pool.getStats()` 获取：

- `total_connections` / `available_connections` / `active_connections`
- `total_acquired` / `total_released` / `total_created` / `total_destroyed`
- `avg_acquire_time_ms` / `max_acquire_time_ms`
- `peak_active_connections`
- `health_check_failures` / `reconnect_attempts` / `validation_failures`

### 维护操作

```cpp
pool.warmup();                      // 预热到最小连接数
pool.expandPool(5);                 // 手动扩容
pool.shrinkPool(10);                // 手动缩容
pool.triggerHealthCheck();          // 触发健康检查
pool.triggerIdleCleanup();          // 清理空闲连接
pool.cleanupUnhealthyConnections(); // 清理不健康连接
pool.shutdown();                    // 关闭连接池
```

---

## RedisTopologyClient — 拓扑客户端

头文件：`async/RedisTopologyClient.h`

提供主从读写分离和集群路由能力。

### RedisMasterSlaveClient — 主从客户端

支持手动指定主从节点，也支持通过 Sentinel 自动发现。

| 方法 | 说明 |
|------|------|
| `connectMaster(addr)` | 连接主节点 |
| `addReplica(addr)` | 添加从节点 |
| `executeWrite(cmd, args)` | 写操作，发往主节点 |
| `executeRead(cmd, args)` | 读操作，轮询从节点 |
| `executeWriteAuto(cmd, args)` | 自动写：失败时重试/刷新拓扑 |
| `executeReadAuto(cmd, args)` | 自动读：失败时重试/刷新拓扑 |
| `setSentinelMasterName(name)` | 设置 Sentinel 监控的 master 名称 |
| `addSentinel(addr)` | 添加 Sentinel 节点 |
| `refreshFromSentinel()` | 从 Sentinel 刷新主从拓扑 |

### RedisClusterClient — 集群客户端

基于 CRC16 哈希的 slot 路由，支持 MOVED/ASK 自动重定向。

| 方法 | 说明 |
|------|------|
| `addNode(addr)` | 添加集群节点（含 slot 范围） |
| `executeByKey(key, cmd, args)` | 按 key 路由到对应节点执行 |
| `executeByKeyAuto(key, cmd, args)` | 自动模式：MOVED/ASK 重定向 + slots 刷新 |
| `setAutoRefreshInterval(interval)` | 设置 slots 自动刷新间隔 |

### RedisCommandResultAwaitable

拓扑客户端的 Auto 方法返回 `RedisCommandResultAwaitable`，同样支持 `.timeout()`。

---

## RedisProtocol — 协议层

头文件：`protocol/RedisProtocol.h`

实现 RESP2 和 RESP3 协议的编解码。

| 类 | 职责 |
|----|------|
| `RespEncoder` | 将命令编码为 RESP 协议格式 |
| `RespParser` | 解析 Redis 响应 |

协议层对用户透明，由 RedisClient 内部调用。

---

## RedisValue — 值类型

头文件：`base/RedisValue.h`

封装 Redis 响应值，支持 RESP2 和 RESP3 的所有数据类型：

| 方法 | 对应类型 |
|------|---------|
| `isNull()` | Null |
| `isString()` / `toString()` | Bulk String |
| `isInteger()` / `toInteger()` | Integer |
| `isArray()` / `toArray()` | Array |
| `isError()` / `toError()` | Error |
| `isDouble()` / `toDouble()` | Double (RESP3) |
| `isBool()` / `toBool()` | Boolean (RESP3) |
| `isMap()` / `toMap()` | Map (RESP3) |
| `isSet()` / `toSet()` | Set (RESP3) |

所有查询方法均为 `const`。

---

## RedisError — 错误类型

头文件：`base/RedisError.h`

```cpp
class RedisError
{
public:
    RedisErrorType type() const;
    std::string message() const;
};
```

错误类型枚举见 [01-快速开始](01-快速开始.md#错误类型)。
