# 00-快速开始

## 依赖

- Galay 内部依赖（构建必需 + 联调推荐）：
  - [galay-kernel](https://github.com/gzj-creator/galay-kernel)（构建必需）
  - [galay-utils](https://github.com/gzj-creator/galay-utils)（推荐）
  - [galay-http](https://github.com/gzj-creator/galay-http)（推荐）
- 支持 C++23 的编译器（推荐 GCC 11+、Clang 14+、AppleClang 15+）
- CMake 3.16+
- spdlog

## 拉取与编译

```bash
git clone https://github.com/gzj-creator/galay-kernel.git
git clone https://github.com/gzj-creator/galay-utils.git
git clone https://github.com/gzj-creator/galay-http.git
git clone https://github.com/gzj-creator/galay-rpc.git
cd galay-rpc
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel
```

仅单独构建 `galay-rpc` 时，最小内部依赖为 `galay-kernel`。

## CMake 开关

- `BUILD_TESTS`：是否构建测试（默认 ON）
- `BUILD_BENCHMARKS`：是否构建基准测试（默认 ON）
- `BUILD_EXAMPLES`：是否构建示例（默认 ON）
- `BUILD_MODULE_EXAMPLES`：是否构建 C++23 模块示例（默认 ON，需要 CMake >= 3.28 + Ninja/VS）

说明：`BUILD_MODULE_EXAMPLES` 需要 CMake >= 3.28 且使用 Ninja 或 Visual Studio 生成器。使用 Unix Makefiles 时该选项会自动关闭。

## 运行测试

```bash
# 协议测试
./build/test/T1-RpcProtocolTest

# 服务端测试（终端 1）
./build/test/T2-RpcServerTest 9750

# 客户端测试（终端 2）
./build/test/T3-RpcClientTest 127.0.0.1 9750
```

## 运行示例

### Echo 示例（四种 RPC 模式）

```bash
# 终端 1：启动服务器
./build/examples/E1-EchoServer 9000

# 终端 2：运行客户端
./build/examples/E2-EchoClient 127.0.0.1 9000
```

### Stream 示例（真实流协议）

```bash
# 终端 1：启动流服务器
./build/examples/E3-StreamServer 9100 1 131072

# 终端 2：运行流客户端
./build/examples/E4-StreamClient 127.0.0.1 9100 200 64
```

### C++23 模块化导入示例

如果构建了模块示例，可以运行 import 版本：

```bash
# Echo import 版本
./build/examples/E1-EchoServerImport 9000
./build/examples/E2-EchoClientImport 127.0.0.1 9000

# Stream import 版本
./build/examples/E3-StreamServerImport 9100 1 131072
./build/examples/E4-StreamClientImport 127.0.0.1 9100 200 64
```

## 最小服务端示例

```cpp
#include "galay-rpc/kernel/RpcServer.h"
#include "galay-rpc/kernel/RpcService.h"

using namespace galay::rpc;
using namespace galay::kernel;

class EchoService : public RpcService {
public:
    EchoService() : RpcService("EchoService") {
        registerMethod("echo", &EchoService::echo);
    }

    Coroutine echo(RpcContext& ctx) {
        auto& req = ctx.request();
        ctx.setPayload(req.payload().data(), req.payload().size());
        co_return;
    }
};

int main() {
    RpcServerConfig config;
    config.port = 9000;

    RpcServer server(config);
    server.registerService(std::make_shared<EchoService>());
    server.start();

    while (server.isRunning()) {
        std::this_thread::sleep_for(std::chrono::seconds(1));
    }
}
```

## 最小客户端示例

```cpp
#include "galay-rpc/kernel/RpcClient.h"
#include "galay-kernel/kernel/Runtime.h"

using namespace galay::rpc;
using namespace galay::kernel;

Coroutine callEcho() {
    RpcClient client;
    co_await client.connect("127.0.0.1", 9000);

    while (true) {
        auto result = co_await client.call("EchoService", "echo", "Hello");
        if (!result) break;
        if (result.value()) {
            auto& response = result.value().value();
            std::string data(response.payload().begin(), response.payload().end());
            std::cout << "Response: " << data << "\n";
            break;
        }
    }

    co_await client.close();
}

int main() {
    Runtime runtime(1, 1);
    runtime.start();

    runtime.getNextIOScheduler()->spawn(callEcho());

    std::this_thread::sleep_for(std::chrono::seconds(3));
    runtime.stop();
}
```

## 模块化导入版本

使用 C++23 模块时，只需一行导入：

```cpp
import galay.rpc;
```

推荐构建方式（Clang 20 + Ninja）：

```bash
cmake -S . -B build-mod -G Ninja \
  -DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm@20/bin/clang++
cmake --build build-mod --target galay-rpc-modules --parallel
```

## 常见问题

### 编译错误：找不到头文件

确保 CMake 能找到 `galay-kernel` 等依赖。可通过 `CMAKE_PREFIX_PATH` 指定：

```bash
cmake -S . -B build -DCMAKE_PREFIX_PATH="/path/to/galay-kernel;/path/to/galay-utils"
```

### 链接错误：undefined reference

检查是否链接了必要的库：

```cmake
target_link_libraries(your_target PRIVATE galay-rpc galay-kernel spdlog::spdlog)
```

### 运行时错误：连接失败

1. 检查服务器是否运行
2. 确认端口号正确
3. 检查防火墙设置
4. 查看服务端日志

### 模块编译失败

当前模块编译路径要求：

- CMake >= 3.28
- Ninja 或 Visual Studio 生成器
- 支持 C++23 模块的编译器

不满足条件时会自动降级到 include 路径。

## 下一步

- 查看 [架构设计](01-架构设计.md) 理解内部实现
- 查看 [API 参考](02-API参考.md) 了解完整接口
- 查看 [使用指南](03-使用指南.md) 学习详细用法
- 查看 [示例代码](05-示例代码.md) 学习常见场景
- 查看 [性能测试](04-性能测试.md) 了解性能数据
