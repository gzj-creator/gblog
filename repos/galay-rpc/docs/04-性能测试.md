# 性能测试

## B1-RPC 压测报告

## 测试环境

| 项目 | 配置 |
|------|------|
| CPU | Apple M4 |
| 内存 | 24 GB |
| 操作系统 | macOS 15.7.3 (Darwin 24.6.0) |
| 编译器 | AppleClang, C++23 |
| 构建类型 | Release |
| 测试日期 | 2026-02-08（基线） / 2026-02-13（优化复测） / 2026-02-14（1-6 优化复测 + 四模式复测） |

## 测试方法

- 服务端：`B1-RpcBenchServer`，Echo 服务，原样返回 payload
- 客户端：`B2-RpcBenchClient`，多连接并发调用，统计 QPS、吞吐量、延迟分布
- 每组测试持续 5~10 秒（按命令参数 `-d`）

## 测试结果

### 1. 不同连接数（256B payload, 2 IO调度器）

| 连接数 | 平均 QPS | 吞吐量 | 总请求数 | 错误率 |
|--------|----------|--------|----------|--------|
| 50 | 170,629 | 83.31 MB/s | 1,713,452 | 0% |
| 100 | 183,338 | 89.52 MB/s | 1,842,185 | 0% |
| 200 | 169,673 | 82.85 MB/s | 1,706,404 | 0% |

**延迟分布（微秒）：**

| 连接数 | Avg | P50 | P90 | P95 | P99 | P99.9 | Max |
|--------|-----|-----|-----|-----|-----|-------|-----|
| 50 | 292 | 223 | 515 | 693 | 1,165 | 2,390 | 30,128 |
| 100 | 544 | 453 | 902 | 1,159 | 1,824 | 3,808 | 26,623 |
| 200 | 1,174 | 973 | 1,823 | 2,299 | 3,812 | 19,142 | 147,583 |

**分析：**
- 100 连接时 QPS 达到峰值 183K，是最佳并发数
- 50 连接时延迟最低（P50 仅 223us），但 QPS 略低
- 200 连接时 QPS 与 50 连接接近，但延迟显著增加，说明连接数过多带来调度开销

### 2. 不同 Payload 大小（100 连接, 2 IO调度器）

| Payload | 平均 QPS | 吞吐量 | 总请求数 | 错误率 |
|---------|----------|--------|----------|--------|
| 256B | 183,338 | 89.52 MB/s | 1,842,185 | 0% |
| 1KB | 178,606 | 348.84 MB/s | 1,793,208 | 0% |

**延迟分布（微秒）：**

| Payload | Avg | P50 | P90 | P95 | P99 | P99.9 | Max |
|---------|-----|-----|-----|-----|-----|-------|-----|
| 256B | 544 | 453 | 902 | 1,159 | 1,824 | 3,808 | 26,623 |
| 1KB | 559 | 464 | 938 | 1,205 | 1,933 | 3,493 | 26,278 |

**分析：**
- Payload 从 256B 增加到 1KB，QPS 仅下降 2.6%，说明协议开销很小
- 吞吐量从 90 MB/s 提升到 349 MB/s，接近 4 倍，符合 payload 大小比例
- 延迟几乎无变化，说明瓶颈不在序列化/反序列化

### 3. 大 Payload + 多 IO 调度器（100 连接, 4KB payload, 4 IO调度器）

| Payload | IO调度器 | 平均 QPS | 吞吐量 | 总请求数 | 错误率 |
|---------|----------|----------|--------|----------|--------|
| 4KB | 4 | 155,697 | 1,216.38 MB/s | 1,563,511 | 0% |

**延迟分布（微秒）：**

| Avg | P50 | P90 | P95 | P99 | P99.9 | Max |
|-----|-----|-----|-----|-----|-------|-----|
| 641 | 392 | 1,235 | 1,789 | 4,010 | 17,071 | 60,573 |

**分析：**
- 4KB payload 下吞吐量达到 1.2 GB/s
- QPS 为 155K，相比 256B 下降 15%，主要受限于数据拷贝和网络带宽
- P50 延迟 392us 仍然很低

### 4. 64KB 大包优化复测（2026-02-13）

> 本组用于验证“分段 writev + 解码路径减拷贝 + 客户端多路复用 + RVO awaitable”后的收益，并扩展客户端并发样本。

#### 4.1 自动 IO 调度器（`-i 0`，零拷贝视图后）

| 客户端连接数 | 平均 QPS | 吞吐量 | 总请求数 | 错误率 |
|-------------|----------|--------|----------|--------|
| 20 | 7,232 | 903.96 MB/s | 36,245 | 0% |
| 50 | 6,606 | 825.77 MB/s | 33,143 | 0% |
| 100 | 7,250 | 906.23 MB/s | 36,416 | 0% |
| 200 | 6,553 | 819.19 MB/s | 32,892 | 0% |
| 400 | 6,550 | 818.75 MB/s | 32,907 | 0% |

#### 4.2 固定 2 个 IO 调度器（`-i 2`，对照）

| 客户端连接数 | 平均 QPS | 吞吐量 | 总请求数 | 错误率 |
|-------------|----------|--------|----------|--------|
| 20 | 2,456 | 306.96 MB/s | 12,330 | 0% |
| 100 | 2,408 | 300.98 MB/s | 12,085 | 0% |
| 200 | 2,453 | 306.67 MB/s | 12,311 | 0% |

**分析：**
- 64KB 场景下，`-i 0` 相比 `-i 2`，QPS 提升约 **169%~201%**（约 1.7~2.0 倍）。
- 大包吞吐在 `-i 0` 下稳定在 **818~906 MB/s**，且所有样本 0 错误。
- 引入 payload 零拷贝视图后，64KB 大包 QPS 从约 4K 提升到 6.5K~7.2K 区间。

### 5. 1-6 优化复测（2026-02-14）

> 本组验证以下改动：response 解析零拷贝视图、客户端 pipeline 深度、服务端单连接 inflight 控制、写路径热点优化、解析路径减拷贝与魔数收敛。

#### 5.1 64KB（100连接，5秒）

| 服务端 inflight | 客户端 pipeline | 平均 QPS | 吞吐量 | 错误率 |
|----------------|----------------|----------|--------|--------|
| 1 | 1 | 88,892 | 11,111.49 MB/s | 0% |
| 4 | 4 | 8,497 | 1,062.16 MB/s | 0% |

#### 5.2 47B（200连接，5秒）

| 服务端 inflight | 客户端 pipeline | 平均 QPS | 吞吐量 | 错误率 |
|----------------|----------------|----------|--------|--------|
| 1 | 4 | 317,774 | 28.49 MB/s | 0% |
| 4 | 4 | 267,961 | 24.02 MB/s | 0% |

**分析：**
- 大包场景下，`inflight=1` 明显优于 `inflight=4`，原因是并发路径需要将请求 payload 从环形缓冲落地为自有内存，复制成本在 64KB 下非常显著。
- 小包场景下，客户端 pipeline（`-l 4`）能稳定把吞吐推到 26~29 万 QPS 区间。
- 本轮将压测错误统计修正为“仅计运行期错误”，避免停止阶段连接关闭带来的伪错误。

### 6. 当前版本复测（2026-02-14）

> 当前代码已移除“单连接内 spawn 子协程并发发送响应”的路径，回归单协程顺序处理。

#### 6.1 64KB（`-i 0`，`-l 1`，5秒）

| 连接数 | 平均 QPS | 吞吐量 | P99 延迟 |
|-------|----------|--------|----------|
| 100 | 87,572 | 10,946.45 MB/s | 12,252 us |
| 200 | 83,015 | 10,376.90 MB/s | 36,727 us |

#### 6.2 47B（`-i 0`，`-l 4`，5秒）

| 连接数 | 平均 QPS | 吞吐量 | P99 延迟 |
|-------|----------|--------|----------|
| 200 | 324,686 | 29.11 MB/s | 43,574 us |

**分析：**
- 大包场景保持在 8.3 万到 8.8 万 QPS 区间，吞吐约 10.3 到 10.9 GB/s。
- 小包 pipeline 场景稳定在 32 万 QPS 级别。

### 7. 四种 RPC 模式 Echo 压测（2026-02-14）

> 服务端已为同一 `echo` 方法注册 `unary/client_stream/server_stream/bidi` 四种模式，客户端通过 `-m` 选择模式。

#### 7.1 小包（47B，200连接，`-i 0`，`-l 4`，5秒）

| 模式 | 平均 QPS | 吞吐量 | P99 延迟 |
|------|----------|--------|----------|
| unary | 345,965 | 31.01 MB/s | 40,811 us |
| client_stream | 277,020 | 24.83 MB/s | 53,104 us |
| server_stream | 293,926 | 26.35 MB/s | 50,927 us |
| bidi | 283,218 | 25.39 MB/s | 71,229 us |

#### 7.2 大包（64KB，100连接，`-i 0`，`-l 1`，5秒）

| 模式 | 平均 QPS | 吞吐量 | P99 延迟 |
|------|----------|--------|----------|
| unary | 87,055 | 10,881.85 MB/s | 15,522 us |
| client_stream | 85,434 | 10,679.27 MB/s | 14,911 us |
| server_stream | 83,592 | 10,449.03 MB/s | 15,271 us |
| bidi | 84,188 | 10,523.46 MB/s | 14,649 us |

**分析：**
- 四种模式均可正常跑通并返回成功响应（非 0 QPS）。
- 当前实现为“单请求帧 -> 单响应帧”链路，模式间性能差距主要来自调度/解析路径细节，整体处于同一量级。
- 64KB 场景下四模式吞吐均在 10.4~10.9 GB/s 区间。

## 每秒 QPS 趋势（100连接, 256B, 2 IO调度器）

```text
QPS (千)
200 ┤
190 ┤          ■   ■       ■   ■   ■
180 ┤  ■   ■               ■       ■
170 ┤  ■
160 ┤              ■
150 ┤
    └──┬───┬───┬───┬───┬───┬───┬───┬───┬───
       1   2   3   4   5   6   7   8   9  10  (秒)
```

QPS 在 166K-193K 之间波动，整体稳定。

## 结论

1. **小包极限**: 47B + pipeline=4 下达到 31.7 万 QPS（200 连接）
2. **大包能力**: 64KB + inflight=1 下达到 8.8 万 QPS、11.1 GB/s 吞吐
3. **并发策略**: 大包优先 `inflight=1`，小包可提高 pipeline 深度换吞吐
4. **稳定性**: 本轮核心样本运行期错误率均为 0%
5. **扩展性**: 协议与客户端已具备 pipeline / inflight 可调能力，可按业务负载选择模式

## 压测命令

```bash
# 启动服务端
./benchmark/B1-RpcBenchServer 9000
# 参数: [port] [io_scheduler_count] [ring_buffer_size]
# 示例:
./benchmark/B1-RpcBenchServer 9000 0 131072

# 不同配置的客户端压测
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 50 -d 10 -s 256 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 10 -s 256 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 10 -s 256 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 10 -s 1024 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 10 -s 4096 -i 4

# 64KB 大包复测（优化后）
./benchmark/B1-RpcBenchServer 9000 0 131072
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 20 -d 5 -s 65536 -i 0
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 50 -d 5 -s 65536 -i 0
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 65536 -i 0
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 400 -d 5 -s 65536 -i 0

# 64KB 对照
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 20 -d 5 -s 65536 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 2
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 65536 -i 2

# 2026-02-14（pipeline / inflight 组合）
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 1
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 4
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 47 -i 0 -l 4

# 四种模式（47B）
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 47 -i 0 -l 4 -m unary
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 47 -i 0 -l 4 -m client_stream
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 47 -i 0 -l 4 -m server_stream
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 200 -d 5 -s 47 -i 0 -l 4 -m bidi

# 四种模式（64KB）
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 1 -m unary
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 1 -m client_stream
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 1 -m server_stream
./benchmark/B2-RpcBenchClient -h 127.0.0.1 -p 9000 -c 100 -d 5 -s 65536 -i 0 -l 1 -m bidi
```

## B3-服务发现压测报告

## 测试环境

| 项目 | 配置 |
|------|------|
| CPU | Apple M4 |
| 内存 | 24 GB |
| 操作系统 | macOS 15.7.3 (Darwin 24.6.0) |
| 编译器 | AppleClang, C++23 |
| 构建类型 | Release |
| 测试日期 | 2026-02-08 |

## 测试方法

- 使用 `B3-ServiceDiscoveryBench` 压测 `AsyncLocalServiceRegistry`
- 每个 worker 独立的 registry 实例，避免 Awaitable& 并发冲突
- 每轮操作包含：注册 -> 发现 -> 注销（3 次操作计为 3 OPS）
- 测试持续 10 秒

## 测试结果

### 配置：100 workers, 2 IO调度器

**每秒 OPS：**

| 秒 | 总 OPS | 注册 | 发现 | 注销 | 错误 |
|----|--------|------|------|------|------|
| 1 | 5,258,727 | 1,752,910 | 1,752,909 | 1,752,908 | 0 |
| 2 | 5,491,762 | 1,830,587 | 1,830,587 | 1,830,588 | 0 |
| 3 | 5,458,928 | 1,819,643 | 1,819,643 | 1,819,642 | 0 |
| 4 | 5,531,791 | 1,843,930 | 1,843,930 | 1,843,931 | 0 |
| 5 | 5,541,861 | 1,847,287 | 1,847,287 | 1,847,287 | 0 |
| 6 | 5,481,624 | 1,827,208 | 1,827,208 | 1,827,208 | 0 |
| 7 | 5,523,622 | 1,841,207 | 1,841,208 | 1,841,207 | 0 |
| 8 | 5,417,487 | 1,805,829 | 1,805,829 | 1,805,829 | 0 |
| 9 | 5,338,282 | 1,779,428 | 1,779,427 | 1,779,427 | 0 |
| 10 | 5,475,683 | 1,825,227 | 1,825,228 | 1,825,228 | 0 |

**汇总：**

| 指标 | 数值 |
|------|------|
| 总操作数 | 54,519,807 |
| 注册操作 | 18,173,269 |
| 发现操作 | 18,173,269 |
| 注销操作 | 18,173,269 |
| 总错误数 | 0 |
| 平均 OPS | **5,432,424** |
| 错误率 | **0.00%** |
| 测试时长 | 10.04 秒 |

**OPS 趋势：**

```text
OPS (百万)
5.6 ┤              ■   ■       ■
5.5 ┤      ■   ■       ■
5.4 ┤                      ■       ■
5.3 ┤                          ■
5.2 ┤  ■
5.1 ┤
    └──┬───┬───┬───┬───┬───┬───┬───┬───┬───
       1   2   3   4   5   6   7   8   9  10  (秒)
```

## 分析

1. **吞吐量极高**: 平均 543 万 OPS，即每秒完成 181 万次完整的 注册-发现-注销 循环
2. **三种操作均衡**: 注册、发现、注销的 OPS 完全一致，说明 AsyncMutex 调度公平
3. **零错误**: 10 秒内 5400 万次操作无任何错误，AsyncMutex 保证了协程安全
4. **稳定性好**: OPS 在 530-554 万之间波动，波动幅度仅 4.5%

## 设计说明

`AsyncLocalServiceRegistry` 使用 `AsyncMutex` 实现协程安全：
- 每次操作先 `co_await m_mutex.lock()` 获取锁
- 操作完成后 `m_mutex.unlock()` 释放锁
- 不会阻塞线程，仅挂起协程

压测中每个 worker 使用独立的 registry 实例，这是因为 `AsyncLocalServiceRegistry` 返回 `Coroutine`（即 `Awaitable&`），同一实例的同一方法不能被多个调用者并发 co_await。生产环境中如需共享 registry，应确保每个调用者串行使用。

## 压测命令

```bash
./benchmark/B3-ServiceDiscoveryBench -w 100 -d 10 -i 2

# 参数说明:
#   -w: worker 数量
#   -d: 测试持续时间（秒）
#   -i: IO 调度器数量
```

## B4-真实流压测报告

## 测试环境

- 时间：2026-02-14
- 机器：Apple M4, 24GB RAM
- 系统：macOS 15.7.3
- 编译：Release（AppleClang）

## 测试目标

验证 `STREAM_*` 协议链路的真实流式行为与性能：

- `STREAM_INIT`
- `STREAM_INIT_ACK`
- 多帧 `STREAM_DATA`
- `STREAM_END`

压测工具：

- 服务端：`B4-RpcStreamBenchServer`
- 客户端：`B5-RpcStreamBenchClient`

## 压测命令

```bash
# 终端 1
./benchmark/B4-RpcStreamBenchServer 9100 1 131072

# 终端 2（单轮）
./benchmark/B5-RpcStreamBenchClient -h 127.0.0.1 -p 9100 -c 100 -d 5 -s 128 -f 16 -i 1
```

参数说明：

- `-c 100`: 100 个并发连接
- `-d 5`: 单轮 5 秒
- `-s 128`: 每帧 128B payload
- `-f 16`: 每个 stream 16 帧
- `-i 1`: 1 个 IO 调度器

## 5 轮结果

| 轮次 | Streams/s | Frames/s | Throughput | P99(us) | Samples |
|------|-----------|----------|------------|---------|---------|
| 1 | 493 | 7892 | 1.93 MB/s | 534512 | 2477 |
| 2 | 379 | 6063 | 1.48 MB/s | 597784 | 1902 |
| 3 | 199 | 3185 | 0.78 MB/s | 687526 | 1000 |
| 4 | 358 | 5736 | 1.40 MB/s | 444069 | 1800 |
| 5 | 155 | 2477 | 0.60 MB/s | 1217434 | 778 |

均值与标准差（样本标准差）：

- Streams/s：`316.80 ± 138.45`
- Frames/s：`5070.60 ± 2217.55`
- Throughput：`1.238 ± 0.543 MB/s`
- P99：`696265 ± 304614 us`

## 结论

- `STREAM_*` 真实流链路可稳定跑通，功能行为符合预期。
- 该配置下吞吐与尾延迟波动较大，后续可继续从连接模型、调度器绑定和写读批量化角度优化。

## 帧级 Pipeline（窗口化收发）压测（2026-02-14）

为了降低“一发一收”带来的往返开销，`B5-RpcStreamBenchClient` 新增 `-w` 参数，支持单个 stream 内的帧级滑动窗口：

- `-w 1`：原始模式（每帧发送后立即等待回包）
- `-w N`：最多允许 `N` 帧在途，再回收回包

测试配置：

- 100 连接
- 128B payload
- 16 frames/stream
- 5 秒
- `-i 0`（自动 IO 调度器）
- 每个窗口跑 3 轮（每轮独立启动服务端，避免状态串扰）

| 窗口 | Streams/s（均值±std） | Frames/s（均值±std） | Throughput（均值±std） | P99(us)（均值±std） | Frames/s 相对 `w=1` |
|------|-----------------------|----------------------|------------------------|---------------------|---------------------|
| 1 | 1865 ± 1309 | 29840 ± 20933 | 7.287 ± 5.108 MB/s | 1204192 ± 397330 | 1.00x |
| 2 | 1583 ± 721 | 25332 ± 11530 | 6.183 ± 2.820 MB/s | 977529 ± 195764 | 0.85x |
| 4 | 4773 ± 347 | 76374 ± 5546 | 18.643 ± 1.353 MB/s | 657909 ± 35548 | 2.56x |
| 8 | 5645 ± 31 | 90325 ± 495 | 22.050 ± 0.123 MB/s | 626780 ± 897 | 3.03x |
| 16 | 5661 ± 751 | 90571 ± 12015 | 22.113 ± 2.933 MB/s | 625961 ± 441 | 3.04x |

结论：

- `w=8` 已接近平台上限，`w=16` 收益基本持平。
- 推荐默认压测窗口可用 `-w 8`（吞吐与稳定性平衡较好）。
