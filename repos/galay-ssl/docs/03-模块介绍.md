# 03-模块介绍

## 项目结构

```text
galay-ssl/
├── galay-ssl/
│   ├── common/
│   │   ├── Defn.hpp            # SSL 枚举与基础类型
│   │   └── Error.h/cc          # SslError / SslErrorCode
│   ├── ssl/
│   │   ├── SslContext.h/cc     # SSL_CTX 配置与证书管理
│   │   └── SslEngine.h/cc      # 单连接 SSL 状态机（Memory BIO）
│   ├── module/
│   │   └── galay.ssl.cppm      # C++23 命名模块接口
│   └── async/
│       ├── SslSocket.h/cc      # 高层异步 SSL Socket
│       └── Awaitable.h/cc      # 握手/收发/关闭 Awaitable
├── examples/
│   ├── include/
│   │   ├── E1-SslEchoServer.cc
│   │   └── E2-SslClient.cc
│   └── import/
│       ├── E1-SslEchoServer.cc
│       └── E2-SslClient.cc
├── test/
│   └── T1-SslSocketTest.cc
├── benchmark/
│   ├── B1-SslBenchServer.cc
│   ├── B1-SslBenchClient.cc
│   └── SslStats.h/cc
└── docs/
```

## SslContext

头文件：`galay-ssl/ssl/SslContext.h`

`SslContext` 封装 OpenSSL 的 `SSL_CTX`，负责 TLS 全局配置和证书加载。一个 `SslContext` 可供多个连接共享。

### 关键接口

| 接口 | 说明 |
|------|------|
| `SslContext(SslMethod)` | 创建 Client/Server/TLS1.2/TLS1.3/DTLS 上下文 |
| `loadCertificate()` / `loadCertificateChain()` | 加载证书 |
| `loadPrivateKey()` | 加载私钥并校验与证书匹配 |
| `loadCACertificate()` / `useDefaultCA()` | 配置信任根 |
| `setVerifyMode()` / `setVerifyDepth()` | 配置证书校验策略 |
| `setCiphers()` / `setCiphersuites()` | 配置密码套件 |
| `setALPNProtocols()` | 配置 ALPN 协议列表 |
| `setSessionCacheMode()` / `setSessionTimeout()` | 配置 Session 缓存 |

## SslEngine

头文件：`galay-ssl/ssl/SslEngine.h`

`SslEngine` 对应单条 TLS 连接，负责调用 OpenSSL 进行握手和加解密。它本身不直接做网络 IO，而是通过 Memory BIO 与外部 IO 层交换密文。

### 关键职责

| 接口 | 说明 |
|------|------|
| `initMemoryBIO()` | 初始化 `rbio/wbio` |
| `setConnectState()` / `setAcceptState()` | 设置客户端/服务端模式 |
| `doHandshake()` | 执行非阻塞握手 |
| `read()` / `write()` | 处理明文读写（内部调用 SSL_read/SSL_write） |
| `feedEncryptedInput()` | 将网络密文写入 `rbio` |
| `extractEncryptedOutput()` | 从 `wbio` 取出待发送密文 |
| `pendingEncryptedOutput()` | 查询待发送密文大小 |
| `getProtocolVersion()` / `getCipher()` / `getALPNProtocol()` | 查询协商结果 |
| `getSession()` / `setSession()` / `isSessionReused()` | Session 复用能力 |

## SslSocket

头文件：`galay-ssl/async/SslSocket.h`

`SslSocket` 是面向业务的高层 API，内部组合 `IOController + SslEngine`，把 TCP + TLS 行为统一成协程友好接口。

### 关键接口

| 接口 | 返回 | 说明 |
|------|------|------|
| `bind(host)` | `expected<void, IOError>` | 绑定地址 |
| `listen(backlog)` | `expected<void, IOError>` | 开始监听 |
| `accept(host*)` | `AcceptAwaitable` | 接收新连接 |
| `connect(host)` | `ConnectAwaitable` | 异步连接 |
| `handshake()` | `SslHandshakeAwaitable` | 执行 TLS 握手 |
| `recv(buf, len)` | `SslRecvAwaitable` | 异步读取明文 |
| `send(buf, len)` | `SslSendAwaitable` | 异步发送明文 |
| `shutdown()` | `SslShutdownAwaitable` | 执行 TLS 关闭握手 |
| `close()` | `CloseAwaitable` | 关闭底层 socket |

补充：`SslSocket` 不可拷贝、可移动；析构时不会自动关闭 fd，需显式 `co_await close()`。

## Awaitable 层

头文件：`galay-ssl/async/Awaitable.h`

### 类型说明

| 类型 | 说明 |
|------|------|
| `SslHandshakeAwaitable` | 多轮握手状态机（RECV/SEND 任务编排） |
| `SslRecvAwaitable` | SSL 读状态机，处理 `WantRead/WantWrite` |
| `SslSendAwaitable` | SSL 写状态机，处理密文分块发送 |
| `SslShutdownAwaitable` | TLS 关闭握手状态机 |

### 超时能力

- `accept/connect/recv/send/close` 支持 `.timeout()`
- `handshake/shutdown` 当前不提供 `.timeout()`

## 错误模型

头文件：`galay-ssl/common/Error.h`

- TLS 相关错误使用 `SslError`
- 系统 IO 相关错误使用 `IOError`（来自 `galay-kernel`）

常见 `SslErrorCode`：

- `kHandshakeFailed`
- `kHandshakeWantRead`
- `kHandshakeWantWrite`
- `kReadFailed`
- `kWriteFailed`
- `kPeerClosed`
- `kSNISetFailed`
- `kALPNSetFailed`

## Benchmark 与 Test

- `T1-SslSocketTest`：基础单元测试（`SslContext` / `SslEngine` / `SslError`）
- `B1-SslBenchServer`：SSL Echo 服务端压测程序
- `B1-SslBenchClient`：并发连接压测客户端（支持 `payload`、`threads`、`connect_retries`）
- `SslStats`：压测侧可选统计模块（`GALAY_SSL_STATS=1`）
