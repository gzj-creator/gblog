# 性能分析

## 测试口径

- 场景：本地环回 SSL Echo（客户端发，服务端原样回）
- 构建：`Release + LTO`
- 服务端：`B1-SslBenchServer`
- 客户端：`B1-SslBenchClient`
- 记录日期：2026-02-13（最新 5 轮串行复测基线）

命令模板：

```bash
./build/bin/B1-SslBenchServer 9443 certs/server.crt certs/server.key
./build/bin/B1-SslBenchClient 127.0.0.1 9443 <connections> <requests> <payload_bytes> <threads>
```

客户端完整参数：

```bash
./build/bin/B1-SslBenchClient <host> <port> <connections> <requests_per_conn> [payload_bytes] [threads] [connect_retries]
```

## 测试环境（归档）

### 硬件

- CPU：Apple M4
- 核心数：10
- 内存：24 GB
- 架构：ARM64

### 软件

- 操作系统：macOS 15.7.3
- 编译器：Apple Clang 17
- C++：23
- OpenSSL：3.5.0
- 调度器：KqueueScheduler

## 关键指标

### 小包场景（47B，偏 QPS）

测试参数：`connections=200, requests_per_conn=500, payload=47, threads=4`

| 指标 | 数值 |
|------|------|
| 完成请求 | 100,000 |
| 错误数 | 0 |
| 耗时 | 616.4 ms（615 / 619） |
| QPS | 162,234（161,551 / 162,602） |
| 吞吐量 | 14.54 MB/s（14.48 / 14.58） |

### 大包场景（64KiB，偏吞吐）

测试参数：`connections=10, requests_per_conn=200, payload=65536, threads=1`

| 指标 | 数值 |
|------|------|
| 完成请求 | 2,000 |
| 错误数 | 0 |
| 耗时 | 126.2 ms（125 / 128） |
| QPS | 15,849（15,625 / 16,000） |
| 吞吐量 | 1,981.10 MB/s（1,953.12 / 2,000.00） |

说明：括号内为 5 轮串行复测中的最小值 / 最大值。

## 补充压测记录

### 64KiB（50 连接，200 请求）

| 完成请求 | 错误数 | 耗时(ms) | 吞吐量(MB/s) |
|---------|-------|---------|-------------|
| 10,000 | 0 | 36,174 | 34.56 |

### 1MiB 正确性检查（1 连接，1 请求）

| 完成请求 | 错误数 | 耗时(ms) |
|---------|-------|---------|
| 1 | 0 | 98 |

## 历史对照（已停更）

说明：

- 曾保留 `OpenSSL + libevent` 对照程序，当前已从仓库移除
- 下表仅作为历史趋势基线，不再更新

### 小包对照（47B）

| 框架 | QPS | 吞吐量(MB/s) | 错误数 |
|------|-----|-------------|-------|
| galay-ssl | 162,234（5轮平均） | 14.54（5轮平均） | 0 |
| OpenSSL + libevent | 178,891（单次） | 16.04（单次） | 0 |

### 大包对照（64KiB）

| 框架 | QPS | 吞吐量(MB/s) | 错误数 |
|------|-----|-------------|-------|
| galay-ssl | 15,849（5轮平均） | 1,981.10（5轮平均） | 0 |
| OpenSSL + libevent | 19,417（单次） | 2,427.18（单次） | 0 |

## 历史阶段记录

- 早期（2026-01-03）曾记录过“数据传输路径未完全跑通”的阶段性状态
- 该状态已过期，当前应以 2026-02-13 及之后基线为准

## 性能观察

- 小包场景下，协议与调度开销占比高，QPS 对事件循环细节更敏感
- 大包场景下，吞吐主要受加解密和内存搬运影响
- 在当前基线中，错误数可控（核心场景 0 错误）
- `threads`、`payload` 与 `connect_retries` 对结果影响显著

## 常见瓶颈

1. TLS 加解密 CPU 开销
2. 大量小包导致系统调用和协议头开销放大
3. 高并发连接建立阶段的抖动（可通过 `connect_retries` 缓解）
4. 未开启 Release/LTO 的构建口径偏差

## 调优建议

### 1. 固定构建口径

```bash
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_LTO=ON
cmake --build build --parallel
```

### 2. 区分目标指标

- 追求 QPS：使用小 payload（如 47B）
- 追求吞吐：使用大 payload（如 64KiB）

### 3. 调整压测参数

- 优先保证 `errors=0`
- 再逐步提高 `connections` / `threads`
- 网络抖动明显时增加 `connect_retries`

### 4. 开启压测侧统计

```bash
GALAY_SSL_STATS=1 ./build/bin/B1-SslBenchClient 127.0.0.1 9443 50 200 47 4
```

可额外观察：

- `Send ops / send plain bytes`
- `Recv ops / recv plain bytes / recv chunks`
- `Avg recv chunk bytes`

## 复现建议

建议每组参数至少运行 5 轮，记录平均值和 min/max，避免单次抖动误导优化结论。
