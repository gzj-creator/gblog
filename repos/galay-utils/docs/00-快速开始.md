# 00-快速开始

## 依赖

- 支持 C++20 的编译器（推荐 GCC 10+、Clang 10+、MSVC 2019 16.8+）
- CMake 3.16+
- 无外部依赖（纯头文件库）

## 拉取与编译

```bash
git clone https://github.com/gzj-creator/galay-utils.git
cd galay-utils
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel
```

## CMake 开关

- `BUILD_TESTS`：是否构建测试（默认 OFF）
- `BUILD_MODULE_TESTS`：是否构建 C++23 模块测试（默认 ON，需要 CMake >= 3.28）

说明：C++23 模块支持自动检测工具链，当前仅 `CMake >= 3.28 + Ninja/Visual Studio + GCC/Clang` 会生效。
模块接口文件：`galay-utils/module/galay.utils.cppm`
预导入头文件：`galay-utils/module/ModulePrelude.hpp`

## 运行测试

```bash
cmake -S . -B build -DBUILD_TESTS=ON
cmake --build build --parallel
./build/test/test_all
```

## 集成到您的项目

### 方法1: 作为子模块

```bash
git submodule add https://github.com/gzj-creator/galay-utils.git third_party/galay-utils
```

在 CMakeLists.txt 中添加：

```cmake
add_subdirectory(third_party/galay-utils)
target_link_libraries(your_target galay-utils)
```

### 方法2: 安装库

```bash
cd galay-utils
mkdir build && cd build
cmake ..
cmake --build . --parallel
sudo cmake --install .
```

然后在您的项目中使用：

```cmake
find_package(galay-utils REQUIRED)
target_link_libraries(your_target galay::galay-utils)
```

### 方法3: 直接复制头文件

由于是纯头文件库，可以直接复制 `galay-utils/` 目录到您的项目中：

```bash
cp -r galay-utils/galay-utils /path/to/your/project/include/
```

## 基本使用

### 传统 include 方式

```cpp
#include <galay-utils/galay-utils.hpp>
#include <iostream>

using namespace galay::utils;

int main() {
    // 字符串处理
    auto parts = StringUtils::split("hello,world", ',');
    std::cout << StringUtils::join(parts, " ") << std::endl;

    // 随机数生成
    auto& rng = Randomizer::instance();
    int random_num = rng.randomInt(1, 100);
    std::cout << "Random: " << random_num << std::endl;

    // 系统信息
    std::cout << "CPU cores: " << System::cpuCount() << std::endl;
    std::cout << "Hostname: " << System::hostname() << std::endl;

    return 0;
}
```

### C++23 模块方式

```cpp
import galay.utils;
#include <iostream>

using namespace galay::utils;

int main() {
    auto parts = StringUtils::split("hello,world", ',');
    std::cout << StringUtils::join(parts, " ") << std::endl;
    return 0;
}
```

编译模块版本：

```bash
cmake -S . -B build-mod -G Ninja \
  -DCMAKE_CXX_COMPILER=g++-14 \
  -DBUILD_MODULE_TESTS=ON
cmake --build build-mod --parallel
```

## 快速示例

### 字符串处理

```cpp
#include <galay-utils/galay-utils.hpp>
using namespace galay::utils;

// 分割和连接
auto parts = StringUtils::split("a,b,c", ',');
std::string joined = StringUtils::join(parts, "-"); // "a-b-c"

// 修剪空白
std::string trimmed = StringUtils::trim("  hello  "); // "hello"

// 大小写转换
std::string lower = StringUtils::toLower("HELLO"); // "hello"
std::string upper = StringUtils::toUpper("hello"); // "HELLO"

// 查找和替换
bool starts = StringUtils::startsWith("hello world", "hello");
std::string replaced = StringUtils::replace("aaa", "a", "b"); // "bbb"
```

### 随机数生成

```cpp
#include <galay-utils/galay-utils.hpp>
using namespace galay::utils;

auto& rng = Randomizer::instance();

// 随机整数
int num = rng.randomInt(1, 100);

// 随机浮点数
double val = rng.randomDouble(0.0, 1.0);

// 随机字符串
std::string str = rng.randomString(10);

// UUID
std::string uuid = rng.uuid();
```

### 线程池

```cpp
#include <galay-utils/galay-utils.hpp>
using namespace galay::utils;

ThreadPool pool(4); // 4 线程

// 提交任务
auto future = pool.addTask([]() {
    return 42;
});

// 获取结果
int result = future.get();
```

### 速率限制

```cpp
#include <galay-utils/galay-utils.hpp>
#include <galay-kernel/kernel/Runtime.h>
using namespace galay::utils;

// 令牌桶限流器
TokenBucketLimiter limiter(100.0, 10); // 100 tokens/sec, 容量 10

// 协程中使用
Coroutine task(IOScheduler* scheduler) {
    // 获取令牌
    co_await limiter.acquire(5);

    // 处理请求
    // ...
}
```

### 熔断器

```cpp
#include <galay-utils/galay-utils.hpp>
using namespace galay::utils;

CircuitBreakerConfig config;
config.failureThreshold = 5;
config.successThreshold = 3;
config.resetTimeout = std::chrono::seconds(30);

CircuitBreaker cb(config);

// 执行请求
try {
    auto result = cb.execute([&]() {
        return doRequest();
    });
} catch (const std::runtime_error& e) {
    // 熔断器开放或请求失败
}
```

### 负载均衡

```cpp
#include <galay-utils/galay-utils.hpp>
using namespace galay::utils;

std::vector<std::string> nodes = {"node1", "node2", "node3"};

// 轮询
RoundRobinLoadBalancer<std::string> rr(nodes);
auto selected = rr.select();

// 加权轮询
std::vector<uint32_t> weights = {3, 2, 1};
WeightRoundRobinLoadBalancer<std::string> wrr(nodes, weights);
auto weighted = wrr.select();

// 随机
RandomLoadBalancer<std::string> random(nodes);
auto rand_node = random.select();
```

## 常见问题

### Q: 编译时找不到头文件

**A:** 确保 CMake 能找到库，使用 `CMAKE_PREFIX_PATH` 指定：

```bash
cmake -S . -B build -DCMAKE_PREFIX_PATH="/path/to/galay-utils"
```

### Q: 链接时出现 undefined reference 错误

**A:** 检查是否链接了必要的库：

```cmake
target_link_libraries(your_target PRIVATE galay-utils)

# Linux 需要额外链接
if(UNIX AND NOT APPLE)
    target_link_libraries(your_target PRIVATE pthread dl)
endif()
```

### Q: C++23 模块编译失败

**A:** 模块编译有严格的工具链要求：

- CMake >= 3.28
- Ninja 或 Visual Studio 生成器
- GCC >= 14 或 Clang >= 16（非 AppleClang）

不满足条件时会自动降级到 include 路径。

### Q: 速率限制器需要 galay-kernel

**A:** 速率限制器的协程接口依赖 galay-kernel。如果只使用 `tryAcquire()` 非阻塞接口，则不需要 galay-kernel：

```cpp
// 不需要 galay-kernel
if (limiter.tryAcquire(5)) {
    // 处理请求
}

// 需要 galay-kernel
co_await limiter.acquire(5);
```

## 下一步

- 查看 [架构设计](01-架构设计.md) 了解整体结构
- 查看 [API 索引](02-API索引.md) 查找具体模块
- 查看 [示例代码](03-示例代码.md) 学习常见用法
- 查看 [常见问题](05-常见问题.md) 解决疑难问题
