# 01-架构设计

## 整体分层

Galay-Utils 采用模块化设计，各模块独立且可组合：

```text
应用层
  ├─ 应用框架 (App, Parser)
  └─ 系统集成 (Process, Signal, BackTrace)
        ↓
业务层
  ├─ 网络与分布式 (RateLimiter, CircuitBreaker, Balancer)
  └─ 并发编程 (Thread, Pool)
        ↓
数据层
  ├─ 数据结构 (TrieTree, ConsistentHash, Mvcc)
  └─ 编码与压缩 (Huffman, Algorithm)
        ↓
基础层
  ├─ 核心工具 (String, Random, System)
  └─ 通用组件 (TypeName, Defn)
```

## 模块职责

### 基础层

#### String
- 字符串分割、连接、修剪
- 大小写转换、查找替换
- 十六进制编码/解码
- 数值验证和解析
- 格式化输出

#### Random
- 高质量随机数生成（Mersenne Twister）
- 线程安全的单例模式
- 支持整数、浮点数、字符串、UUID
- 随机字节生成

#### System
- 系统信息查询（CPU、内存、主机名）
- 文件操作（读写、存在性检查、大小）
- 时间戳和格式化
- 环境变量管理
- 进程 ID 和用户信息

#### TypeName
- 编译期类型名称提取
- 跨平台类型名称规范化
- 支持模板类型和复杂类型

### 数据层

#### TrieTree
- 前缀树实现
- 高效的字符串查找和前缀匹配
- 支持插入、查找、删除操作

#### ConsistentHash
- 一致性哈希算法
- 虚拟节点支持
- 节点动态增删
- 负载均衡

#### Mvcc
- 多版本并发控制
- 无锁读取
- 版本管理
- 事务隔离

#### Huffman
- 霍夫曼编码/解码
- 数据压缩
- 频率统计

#### Algorithm
- **Base64**: Base64 编码/解码
- **MD5**: MD5 哈希算法
- **HMAC**: HMAC 消息认证码
- **MurmurHash3**: 高性能哈希函数
- **Salt**: 密码加盐工具

### 业务层

#### Thread
- **ThreadPool**: 线程池实现
- **TaskWaiter**: 任务等待器
- **ThreadSafeList**: 线程安全链表
- 支持任务提交和结果获取

#### Pool
- **ObjectPool**: 对象池
- **BlockingObjectPool**: 阻塞对象池
- 资源复用和管理
- 线程安全

#### RateLimiter
- **CountingSemaphore**: 计数信号量
- **TokenBucketLimiter**: 令牌桶限流
- **SlidingWindowLimiter**: 滑动窗口限流
- **LeakyBucketLimiter**: 漏桶限流
- 无锁原子实现
- 协程异步接口（依赖 galay-kernel）

#### CircuitBreaker
- 熔断器模式实现
- 三种状态：关闭、开放、半开放
- 无锁原子状态转换
- 自动恢复机制
- 降级支持

#### Balancer
- **RoundRobinLoadBalancer**: 轮询负载均衡
- **WeightRoundRobinLoadBalancer**: 加权轮询
- **RandomLoadBalancer**: 随机负载均衡
- **WeightedRandomLoadBalancer**: 加权随机
- 动态节点管理

### 应用层

#### App
- 命令行参数解析
- 选项和标志支持
- 帮助信息生成
- 参数验证

#### Parser
- INI 配置文件解析
- 环境变量解析
- 键值对管理
- 注释支持

#### Process
- 进程管理
- 进程创建和控制
- 进程间通信
- 状态查询

#### Signal
- 信号处理器
- 信号注册和回调
- 跨平台信号支持
- 优雅关闭

#### BackTrace
- 栈追踪
- 错误诊断
- 调试支持
- 符号解析

## 设计原则

### 1. 纯头文件库

所有模块均为头文件实现，无需编译链接，简化集成：

- 无外部依赖（除 RateLimiter 的协程接口需要 galay-kernel）
- 快速集成
- 跨平台兼容

### 2. 零拷贝设计

关键路径避免不必要的拷贝：

- 字符串操作使用 `string_view`
- 容器返回引用或可选值
- 移动语义优先

### 3. 线程安全

并发模块提供线程安全保证：

- 原子操作和 CAS
- 无锁数据结构
- 互斥锁保护

### 4. 性能优化

针对性能关键路径优化：

- 内存预分配
- 缓存友好设计
- 参数验证前置
- 边界检查优化

### 5. 现代 C++

充分利用 C++20/23 特性：

- 概念和约束
- 协程支持
- 模块化（可选）
- 范围和视图

## 模块依赖关系

```text
RateLimiter ──> galay-kernel (协程接口)
     │
     └──> 其他模块无外部依赖

所有模块 ──> C++20 标准库
```

## 内存管理

### 对象池

`ObjectPool` 和 `BlockingObjectPool` 提供对象复用：

- 预分配对象
- 减少内存分配开销
- 线程安全访问

### 字符串优化

`StringUtils` 使用预分配策略：

- 避免频繁的内存分配
- 使用 `reserve()` 预留空间
- 移动语义减少拷贝

### 容器选择

根据使用场景选择合适的容器：

- `vector`: 连续内存，缓存友好
- `unordered_map`: 快速查找
- `list`: 频繁插入删除

## 并发模型

### 线程池

`ThreadPool` 使用工作队列模式：

- 固定数量的工作线程
- 任务队列
- 条件变量同步

### 无锁设计

`RateLimiter` 和 `CircuitBreaker` 使用无锁原子操作：

- `std::atomic` 原子变量
- CAS（Compare-And-Swap）操作
- 避免锁竞争

### 协程支持

`RateLimiter` 提供协程异步接口：

- 基于 galay-kernel 的 `CustomAwaitable`
- 非阻塞等待
- 超时支持

## 错误处理

### 异常安全

大部分模块提供异常安全保证：

- 基本保证：不泄漏资源
- 强保证：操作失败时状态不变
- 无异常保证：标记为 `noexcept`

### 返回值检查

部分接口返回可选值：

- `std::optional<T>`: 可能失败的操作
- `std::expected<T, E>`: 错误详情（C++23）
- 布尔返回值：简单成功/失败

## 性能考量

### 高性能特性

- **零拷贝**: 使用视图和引用避免拷贝
- **内存预分配**: 减少动态分配
- **无锁设计**: 避免锁竞争
- **缓存友好**: 连续内存布局

### 性能数据

| 模块 | 操作 | 性能 |
|------|------|------|
| CircuitBreaker | allowRequest | ~10M ops/sec |
| RateLimiter | tryAcquire | ~3-4M ops/sec |
| StringUtils | split | ~1M ops/sec |
| Randomizer | randomInt | ~10M ops/sec |

### 优化建议

1. **字符串操作**: 使用 `string_view` 避免拷贝
2. **随机数生成**: 复用 `Randomizer` 实例
3. **线程池**: 根据 CPU 核心数设置线程数
4. **对象池**: 预分配足够的对象
5. **限流器**: 使用 `tryAcquire()` 避免协程开销

## 跨平台支持

### 平台差异处理

- **Linux**: 完整支持所有功能
- **macOS**: 完整支持所有功能
- **Windows**: 部分功能需要适配（如信号处理）

### 编译器支持

- **GCC**: 10+ (C++20), 14+ (C++23 模块)
- **Clang**: 10+ (C++20), 16+ (C++23 模块)
- **MSVC**: 2019 16.8+ (C++20)

## 扩展性

### 自定义类型

大部分模块支持自定义类型：

```cpp
// 负载均衡器支持任意类型
struct Server {
    std::string host;
    int port;
};

RoundRobinLoadBalancer<Server> balancer(servers);
```

### 策略模式

部分模块支持策略定制：

```cpp
// 对象池支持自定义工厂
ObjectPool<Connection> pool(
    []() { return std::make_unique<Connection>(); },
    10
);
```

## 最佳实践

### 1. 模块选择

根据需求选择合适的模块：

- 字符串处理 → `StringUtils`
- 随机数 → `Randomizer`
- 并发控制 → `ThreadPool` + `RateLimiter`
- 负载均衡 → `Balancer`
- 容错 → `CircuitBreaker`

### 2. 性能优化

- 避免频繁创建销毁对象，使用对象池
- 字符串操作使用 `string_view`
- 限流器优先使用 `tryAcquire()`
- 线程池大小设置为 CPU 核心数

### 3. 错误处理

- 检查返回值和可选值
- 捕获可能的异常
- 使用 RAII 管理资源

### 4. 线程安全

- 了解模块的线程安全性
- 必要时使用互斥锁保护
- 避免数据竞争

## 未来规划

### 计划中的功能

- 更多编码算法（SHA256、AES）
- 分布式锁
- 更多数据结构（跳表、布隆过滤器）
- 网络工具（URL 解析、HTTP 客户端）
- 日志框架集成

### 性能优化

- SIMD 加速字符串操作
- 更高效的内存分配器
- 更多无锁数据结构
