# API 接口参考

Base URL: `http://localhost:8000`

---

## 健康检查

### GET /

```json
// Response 200
{
  "status": "ok",
  "service": "Galay AI Service",
  "version": "2.0.0"
}
```

### GET /health

```json
// Response 200
{ "status": "ok" }
```

---

## 聊天

### POST /api/chat

智能问答接口，支持会话记忆。

**请求体：**

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `message` | string | 是 | — | 用户消息 |
| `session_id` | string | 否 | `"default"` | 会话 ID |
| `use_memory` | boolean | 否 | `true` | 是否使用会话记忆 |

**请求示例：**

```json
{
  "message": "Galay 框架支持哪些 I/O 多路复用？",
  "session_id": "user_abc_123",
  "use_memory": true
}
```

**响应：**

```json
{
  "success": true,
  "response": "Galay 框架支持以下 I/O 多路复用机制：\n\n1. epoll (Linux)\n2. kqueue (macOS/BSD)\n3. io_uring (Linux 5.1+)\n\n...",
  "sources": [
    {
      "project": "galay-kernel",
      "file": "docs/io-multiplexing.md",
      "file_name": "io-multiplexing.md"
    }
  ],
  "session_id": "user_abc_123"
}
```

**错误响应：**

```json
// 400 — 空消息
{ "detail": "Message cannot be empty" }

// 429 — 请求限流（30 次/分钟/IP）
{ "error": "Rate limit exceeded: 30 per 1 minute" }

// 500 — 服务异常
{ "success": false, "error": "Chat failed: ..." }
```

---

### POST /api/chat/stream

流式聊天接口（SSE），逐字返回 LLM 生成内容。请求体与 `/api/chat` 相同。

**响应格式：** `text/event-stream`

每个事件为一行 `data: {...}\n\n`：

```
data: {"content": "Galay"}
data: {"content": " 框架"}
data: {"content": "支持..."}
...
data: {"done": true, "sources": [{"project": "galay-kernel", "file": "docs/io.md", "file_name": "io.md"}]}
```

**错误事件：**

```
data: {"error": "Chat failed: ..."}
```

---

## 搜索

### POST /api/search

直接搜索向量存储中的文档片段。

**请求体：**

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `query` | string | 是 | — | 搜索查询 |
| `k` | integer | 否 | `3` | 返回结果数量 |

**请求示例：**

```json
{
  "query": "协程调度器",
  "k": 5
}
```

**响应：**

```json
{
  "success": true,
  "results": [
    {
      "content": "## 协程调度器\n\nGalay 的协程调度器基于...",
      "metadata": {
        "source": "docs/scheduler.md",
        "project": "galay-kernel",
        "file_name": "scheduler.md"
      },
      "score": 0.82
    }
  ]
}
```

---

## 管理接口

### POST /api/rebuild

重建向量索引。需要确认参数防止误操作。

**请求体：**

```json
{ "confirm": true }
```

**响应：**

```json
{ "success": true, "message": "Index rebuilt" }
```

### GET /api/stats

获取服务统计信息。

**响应：**

```json
{
  "success": true,
  "stats": {
    "active_sessions": 3,
    "model": "gpt-4-turbo-preview",
    "embedding_model": "text-embedding-3-small",
    "doc_paths": 7,
    "index": {
      "status": "ready",
      "doc_count": 156
    }
  }
}
```

### DELETE /api/session/{session_id}

清除指定会话的对话记忆。

**响应：**

```json
{ "success": true, "message": "Session user_abc_123 cleared" }
```

---

## 错误码

| HTTP 状态码 | 说明 |
|-------------|------|
| 200 | 成功 |
| 400 | 请求参数错误（空消息、未确认重建等） |
| 429 | 请求限流（超过频率限制） |
| 500 | 服务内部错误（配置错误、向量存储异常等） |
